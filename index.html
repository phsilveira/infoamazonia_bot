
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://infoamazonia.org/">
      
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.48">
    
    
      
        <title>Infoamazonia_bot</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Infoamazonia_bot" >
      
        <meta  property="og:description"  content="None" >
      
        <meta  property="og:image"  content="https://infoamazonia.org/assets/images/social/index.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://infoamazonia.org/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Infoamazonia_bot" >
      
        <meta  name="twitter:description"  content="None" >
      
        <meta  name="twitter:image"  content="https://infoamazonia.org/assets/images/social/index.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#homepage" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="Infoamazonia_bot" class="md-header__button md-logo" aria-label="Infoamazonia_bot" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Infoamazonia_bot
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Homepage
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="." class="md-tabs__link">
        
  
    
  
  Homepage

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Infoamazonia_bot" class="md-nav__button md-logo" aria-label="Infoamazonia_bot" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Infoamazonia_bot
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Homepage
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Homepage
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    <span class="md-ellipsis">
      Classes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#app" class="md-nav__link">
    <span class="md-ellipsis">
      App
    </span>
  </a>
  
    <nav class="md-nav" aria-label="App">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#webhook" class="md-nav__link">
    <span class="md-ellipsis">
      Webhook
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bot" class="md-nav__link">
    <span class="md-ellipsis">
      Bot
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#call-the-manager" class="md-nav__link">
    <span class="md-ellipsis">
      Call the Manager
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database" class="md-nav__link">
    <span class="md-ellipsis">
      Database
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Database">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-connection" class="md-nav__link">
    <span class="md-ellipsis">
      Check connection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-last-n-docs" class="md-nav__link">
    <span class="md-ellipsis">
      Get last n docs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-a-document" class="md-nav__link">
    <span class="md-ellipsis">
      Find a document
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insert-a-document" class="md-nav__link">
    <span class="md-ellipsis">
      Insert a document
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-a-document" class="md-nav__link">
    <span class="md-ellipsis">
      Delete a document
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manager" class="md-nav__link">
    <span class="md-ellipsis">
      Manager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-last-news-and-call-the-nofitification" class="md-nav__link">
    <span class="md-ellipsis">
      Get last news and call the nofitification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-user-prefrences-and-news-topics" class="md-nav__link">
    <span class="md-ellipsis">
      Get user prefrences and news topics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-message-for-each-user" class="md-nav__link">
    <span class="md-ellipsis">
      Create a message for each user
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-for-new-news" class="md-nav__link">
    <span class="md-ellipsis">
      Check for new news
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#incialization" class="md-nav__link">
    <span class="md-ellipsis">
      Incialization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#news" class="md-nav__link">
    <span class="md-ellipsis">
      News
    </span>
  </a>
  
    <nav class="md-nav" aria-label="News">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#incialization_1" class="md-nav__link">
    <span class="md-ellipsis">
      Incialization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-news" class="md-nav__link">
    <span class="md-ellipsis">
      Get news
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-the-news-source-url" class="md-nav__link">
    <span class="md-ellipsis">
      Get the news source URL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validate-a-news" class="md-nav__link">
    <span class="md-ellipsis">
      Validate a news
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-topics-of-the-news" class="md-nav__link">
    <span class="md-ellipsis">
      Getting topics of the news
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#whatsapp_client" class="md-nav__link">
    <span class="md-ellipsis">
      whatsapp_client
    </span>
  </a>
  
    <nav class="md-nav" aria-label="whatsapp_client">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dictionary-of-messages" class="md-nav__link">
    <span class="md-ellipsis">
      Dictionary of messages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saving-the-state-of-conversation" class="md-nav__link">
    <span class="md-ellipsis">
      Saving the state of conversation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stories-message-template" class="md-nav__link">
    <span class="md-ellipsis">
      Stories message template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opinion-message-template" class="md-nav__link">
    <span class="md-ellipsis">
      Opinion message template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sending-a-message" class="md-nav__link">
    <span class="md-ellipsis">
      Sending a message
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-other-types-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      Processing other types of contents
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#main-menu" class="md-nav__link">
    <span class="md-ellipsis">
      Main menu
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-user-preferences" class="md-nav__link">
    <span class="md-ellipsis">
      Get user preferences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-user" class="md-nav__link">
    <span class="md-ellipsis">
      Create a user
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#choose-all-content" class="md-nav__link">
    <span class="md-ellipsis">
      Choose all content
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-single-button" class="md-nav__link">
    <span class="md-ellipsis">
      Create a single button
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saving-user-prefrences" class="md-nav__link">
    <span class="md-ellipsis">
      Saving user prefrences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#topics-menu" class="md-nav__link">
    <span class="md-ellipsis">
      Topics menu
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#topics-options" class="md-nav__link">
    <span class="md-ellipsis">
      Topics options
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#location-menu" class="md-nav__link">
    <span class="md-ellipsis">
      Location menu
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locations-options" class="md-nav__link">
    <span class="md-ellipsis">
      Locations options
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manage-the-users-choices" class="md-nav__link">
    <span class="md-ellipsis">
      Manage the user's choices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#process-subscriptions" class="md-nav__link">
    <span class="md-ellipsis">
      Process subscriptions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#process-statuses" class="md-nav__link">
    <span class="md-ellipsis">
      Process statuses
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#process-webhook-notification" class="md-nav__link">
    <span class="md-ellipsis">
      Process webhook notification
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="homepage">Homepage</h1>
<p>In order to develop this bot, it was imperative to integrate the WhatsApp Business API with the WordPress API. Essentially, the bot functions as follows: a scheduler is employed to periodically check for newly published articles on WordPress. Upon discovering a new article, it is stored in the database and initiates a notification to the Manager, who retrieves all active users from the database. Subsequently, the users' preferences are cross-referenced with the article's topics. If the preferences align with the article's themes, a message is dispatched to the user.</p>
<h2 id="classes">Classes</h2>
<h3 id="app">App</h3>
<p>This class contain the routes for WhatsApp Busines API</p>
<h4 id="webhook">Webhook</h4>
<p>The webhook route is triggered when a new message arrives for the bot. When this happens, the message is sent to the <code>process_webhook_notification</code> method of the <code>whatsapp_client</code> class.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>    <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/webhook/&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="k">def</span> <span class="nf">webhook_whatsapp</span><span class="p">():</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;__summary__: Get message from the webhook&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hub.verify_token&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>                <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hub.challenge&quot;</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>            <span class="k">return</span> <span class="s2">&quot;Authentication failed. Invalid Token.&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="n">client</span> <span class="o">=</span> <span class="n">WhatsAppWrapper</span><span class="p">()</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">process_webhook_notification</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">())</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="c1"># Do anything with the response</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="c1"># Sending a message to a phone number to confirm the webhook is working</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">},</span> <span class="mi">200</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="bot">Bot</h3>
<h4 id="call-the-manager">Call the Manager</h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>    <span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>    <span class="n">manager</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<h3 id="database">Database</h3>
<p>The Database class contains basic methods (save, read, update, and delete) to manage news and users in MongoDB.</p>
<h4 id="check-connection">Check connection</h4>
<p>This method check if database is online</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span>
<span class="normal"><a href="#__codelineno-2-5">5</a></span>
<span class="normal"><a href="#__codelineno-2-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a>    <span class="k">def</span> <span class="nf">checkConnection</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>            <span class="n">info</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">server_info</span><span class="p">()</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>        <span class="k">except</span> <span class="n">ServerSelectionTimeoutError</span><span class="p">:</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>            <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
<h4 id="get-last-n-docs">Get last n docs</h4>
<p>This method retrieves the last N documents inserted in the database.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a>    <span class="k">def</span> <span class="nf">get_last_n_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">sort_options</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>            <span class="n">collist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list_collection_names</span><span class="p">()</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>            <span class="k">if</span> <span class="n">collection_name</span> <span class="ow">in</span> <span class="n">collist</span><span class="p">:</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>                <span class="n">coll</span>    <span class="o">=</span>    <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">collection_name</span><span class="p">]</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>                <span class="n">doc</span>     <span class="o">=</span>   <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">sort_options</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>                <span class="n">r</span>       <span class="o">=</span>   <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>                <span class="k">if</span>  <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="p">)):</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;docs&quot;</span><span class="p">:</span><span class="n">doc</span><span class="p">}</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">}</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a>            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="find-a-document">Find a document</h4>
<p>This method retrieves a document from the database using a search query.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>            <span class="n">collist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list_collection_names</span><span class="p">()</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>            <span class="k">if</span> <span class="n">collection_name</span> <span class="ow">in</span> <span class="n">collist</span><span class="p">:</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>                <span class="n">coll</span>    <span class="o">=</span>    <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">collection_name</span><span class="p">]</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>                <span class="n">doc</span>     <span class="o">=</span>   <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>                <span class="n">r</span>       <span class="o">=</span>   <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>                <span class="k">if</span>  <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="p">)):</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;docs&quot;</span><span class="p">:</span><span class="n">doc</span><span class="p">}</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">}</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a>            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="insert-a-document">Insert a document</h4>
<p>This method insert N document to the database.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a>    <span class="k">def</span> <span class="nf">insert_many</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">docs</span><span class="p">):</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>        <span class="n">coll</span>  <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span> <span class="n">collection_name</span> <span class="p">]</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>        <span class="n">result</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>                <span class="n">coll</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a>                <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>            <span class="k">except</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">BulkWriteError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>        
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a>                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a>        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
<h4 id="delete-a-document">Delete a document</h4>
<p>This method deletes a document in the database based on the search query.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a>    <span class="k">def</span> <span class="nf">delete_one</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>        <span class="c1">#Example .db.delete_one(&quot;users&quot;,{&quot;user_id&quot;:{&quot;$eq&quot;:user_id}})</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>        <span class="n">coll</span>  <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span> <span class="n">collection_name</span> <span class="p">]</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>        <span class="n">result</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>            <span class="n">r</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">delete_one</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>            <span class="c1">#print(r.deleted_count)</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>            <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>        <span class="k">return</span> <span class="n">result</span>   
</code></pre></div></td></tr></table></div>
<h3 id="manager">Manager</h3>
<p>The Manager class is responsible for application management, coordinating the collection and storage of news, as well as the message dispatch to users.</p>
<h4 id="get-last-news-and-call-the-nofitification">Get last news and call the nofitification</h4>
<p>The update_and_notify method is responsible for updating the database with the latest news obtained from the WordPress API and notifying users if new news is available.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a>    <span class="k">def</span> <span class="nf">update_and_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Get lastest news from Wordpress API&quot;&quot;&quot;</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database update running...&quot;</span><span class="p">)</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>        <span class="n">latest_news</span>     <span class="o">=</span>   <span class="bp">self</span><span class="o">.</span><span class="n">news</span><span class="o">.</span><span class="n">get_news</span><span class="p">()</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>        <span class="k">if</span> <span class="n">latest_news</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of new news:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">latest_news</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;number_of_news&quot;</span><span class="p">)))</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="s2">&quot;news&quot;</span><span class="p">,</span><span class="n">latest_news</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;news&quot;</span><span class="p">)):</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__notify_users</span><span class="p">(</span><span class="n">latest_news</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;news&quot;</span><span class="p">))</span>    
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The database was already updated&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="get-user-prefrences-and-news-topics">Get user prefrences and news topics</h4>
<p>The __pre_process method is a pre-processing step that takes a user and a list of last news as inputs. It extracts the user's topic and location preferences and filters the news based on these preferences. Unique news items that meet certain conditions are added to the user's news list, considering options for receiving all content or specific topics only. The method ensures uniqueness of URLs and titles, extracts relevant information from the news items, and constructs a dictionary object representing each news item. The updated user object with filtered news items is returned.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span>
<span class="normal"><a href="#__codelineno-8-33">33</a></span>
<span class="normal"><a href="#__codelineno-8-34">34</a></span>
<span class="normal"><a href="#__codelineno-8-35">35</a></span>
<span class="normal"><a href="#__codelineno-8-36">36</a></span>
<span class="normal"><a href="#__codelineno-8-37">37</a></span>
<span class="normal"><a href="#__codelineno-8-38">38</a></span>
<span class="normal"><a href="#__codelineno-8-39">39</a></span>
<span class="normal"><a href="#__codelineno-8-40">40</a></span>
<span class="normal"><a href="#__codelineno-8-41">41</a></span>
<span class="normal"><a href="#__codelineno-8-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a>    <span class="k">def</span> <span class="nf">__pre_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="n">last_news</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>        <span class="n">user_topics_prefs</span>       <span class="o">=</span>   <span class="nb">set</span><span class="p">(</span>    <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;topics_prefs&quot;</span><span class="p">)</span>    <span class="p">)</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>        <span class="n">user_locations_prefs</span>    <span class="o">=</span>   <span class="nb">set</span><span class="p">(</span>    <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;locations_prefs&quot;</span><span class="p">)</span> <span class="p">)</span>   
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>        <span class="n">user_all_content</span>        <span class="o">=</span>   <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;all_content&quot;</span><span class="p">)</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>        <span class="n">user</span><span class="p">[</span><span class="s1">&#39;news&#39;</span><span class="p">]</span>    <span class="o">=</span>   <span class="p">[]</span>          
<a id="__codelineno-8-7" name="__codelineno-8-7"></a>        <span class="n">news_locations</span>  <span class="o">=</span>   <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>        <span class="n">urls</span>    <span class="o">=</span>   <span class="p">[]</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>        <span class="n">titles</span>  <span class="o">=</span>   <span class="p">[]</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a>        <span class="k">for</span> <span class="n">news</span> <span class="ow">in</span> <span class="n">last_news</span><span class="p">:</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>                <span class="n">news_topics</span> <span class="o">=</span>   <span class="nb">set</span><span class="p">(</span><span class="n">news</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;News_topics&quot;</span><span class="p">))</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a>            <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>                <span class="n">news_topics</span> <span class="o">=</span>   <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a>            <span class="k">if</span> <span class="n">news</span><span class="p">[</span><span class="s1">&#39;URL&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">urls</span> <span class="ow">and</span> <span class="n">news</span><span class="p">[</span><span class="s1">&#39;Language&#39;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;pt-BR&quot;</span> <span class="ow">and</span>  <span class="n">news</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">titles</span><span class="p">:</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a>                <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">news</span><span class="p">[</span><span class="s1">&#39;URL&#39;</span><span class="p">])</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a>                <span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">news</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">])</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a>                <span class="k">if</span> <span class="n">news</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">):</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a>                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a>                        <span class="n">news_locations</span>  <span class="o">=</span>   <span class="nb">set</span><span class="p">([</span><span class="n">news</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)])</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a>                    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a>                        <span class="n">news_locations</span>  <span class="o">=</span>   <span class="nb">set</span><span class="p">()</span>       
<a id="__codelineno-8-24" name="__codelineno-8-24"></a>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a>                <span class="n">n</span>   <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a>                        <span class="s2">&quot;Title&quot;</span><span class="p">:</span><span class="n">news</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Title&quot;</span><span class="p">)</span> <span class="p">,</span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a>                        <span class="s2">&quot;Description&quot;</span><span class="p">:</span><span class="n">news</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">),</span>
<a id="__codelineno-8-28" name="__codelineno-8-28"></a>                         <span class="s2">&quot;Author&quot;</span><span class="p">:</span><span class="n">news</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Author&quot;</span><span class="p">),</span>
<a id="__codelineno-8-29" name="__codelineno-8-29"></a>                         <span class="s2">&quot;Subtopics&quot;</span><span class="p">:</span><span class="n">news</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Subtopics&quot;</span><span class="p">),</span>
<a id="__codelineno-8-30" name="__codelineno-8-30"></a>                         <span class="s2">&quot;URL&quot;</span><span class="p">:</span><span class="n">news</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;URL&quot;</span><span class="p">),</span>
<a id="__codelineno-8-31" name="__codelineno-8-31"></a>                         <span class="s2">&quot;news_source&quot;</span><span class="p">:</span><span class="n">news</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;news_source&quot;</span><span class="p">)</span>
<a id="__codelineno-8-32" name="__codelineno-8-32"></a>                    <span class="p">}</span>
<a id="__codelineno-8-33" name="__codelineno-8-33"></a>
<a id="__codelineno-8-34" name="__codelineno-8-34"></a>
<a id="__codelineno-8-35" name="__codelineno-8-35"></a>                <span class="k">if</span>  <span class="n">user_all_content</span><span class="p">:</span>
<a id="__codelineno-8-36" name="__codelineno-8-36"></a>                    <span class="n">user</span><span class="p">[</span><span class="s1">&#39;news&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a id="__codelineno-8-37" name="__codelineno-8-37"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-8-38" name="__codelineno-8-38"></a>                    <span class="k">if</span> <span class="n">user_topics_prefs</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">news_topics</span><span class="p">):</span>
<a id="__codelineno-8-39" name="__codelineno-8-39"></a>                        <span class="n">user</span><span class="p">[</span><span class="s1">&#39;news&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a id="__codelineno-8-40" name="__codelineno-8-40"></a>                    <span class="k">elif</span> <span class="n">user_locations_prefs</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">news_locations</span><span class="p">):</span>
<a id="__codelineno-8-41" name="__codelineno-8-41"></a>                        <span class="n">user</span><span class="p">[</span><span class="s1">&#39;news&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a id="__codelineno-8-42" name="__codelineno-8-42"></a>        <span class="k">return</span> <span class="n">user</span>
</code></pre></div></td></tr></table></div>
<h4 id="create-a-message-for-each-user">Create a message for each user</h4>
<p>The __create_messages method takes user data and news as input. It processes each user's data and the news to create customized messages for each user. The processed user data is stored in a list, which is then returned. The method essentially generates messages tailored to individual users based on their data and the provided news.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span>
<span class="normal"><a href="#__codelineno-9-4">4</a></span>
<span class="normal"><a href="#__codelineno-9-5">5</a></span>
<span class="normal"><a href="#__codelineno-9-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a>    <span class="k">def</span> <span class="nf">__create_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">users_db</span><span class="p">,</span> <span class="n">news</span><span class="p">):</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>        <span class="n">users</span>   <span class="o">=</span>   <span class="p">[]</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users_db</span><span class="p">:</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__pre_process</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="n">news</span><span class="p">))</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>        <span class="k">return</span> <span class="n">users</span>
</code></pre></div></td></tr></table></div>
<h4 id="check-for-new-news">Check for new news</h4>
<p>The start_scheduler method sets up a scheduler object and schedules a recurring task to check for new news. It creates a BackgroundScheduler object with a daemon thread and a specified timezone. The scheduled task, update_and_notify, is triggered at regular intervals of every hour. If desired, the interval can be adjusted to minutes instead of hours by modifying the minutes parameter in the scheduler.add_job line. This method enables the automated execution of the update_and_notify task on a regular schedule.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span>
<span class="normal"><a href="#__codelineno-10-3">3</a></span>
<span class="normal"><a href="#__codelineno-10-4">4</a></span>
<span class="normal"><a href="#__codelineno-10-5">5</a></span>
<span class="normal"><a href="#__codelineno-10-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a>    <span class="k">def</span> <span class="nf">start_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Create a scheduler object and schedule a task that check for new news each hour&quot;&quot;&quot;</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>        <span class="n">scheduler</span> <span class="o">=</span> <span class="n">BackgroundScheduler</span><span class="p">(</span><span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timezone</span><span class="o">=</span><span class="s2">&quot;America/Sao_Paulo&quot;</span><span class="p">)</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>        <span class="c1">#Each X minutes or hours</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>        <span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_and_notify</span><span class="p">,</span> <span class="n">trigger</span><span class="o">=</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span> <span class="c1">#change to minutes</span>
</code></pre></div></td></tr></table></div>
<h4 id="incialization">Incialization</h4>
<p>The start method begins the execution of the application by setting up the scheduler, checking for new news, and initiating the application to run in debug mode. It starts the scheduler to periodically check for new news, immediately checks for updates and notifies users, and then launches the application to listen for incoming requests on port 5000. </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span>
<span class="normal"><a href="#__codelineno-11-2">2</a></span>
<span class="normal"><a href="#__codelineno-11-3">3</a></span>
<span class="normal"><a href="#__codelineno-11-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_scheduler</span><span class="p">()</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_and_notify</span><span class="p">()</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span><span class="c1">#,ssl_context=(&#39;cert.pem&#39;, &#39;key.pem&#39;))</span>
</code></pre></div></td></tr></table></div>
<h3 id="news">News</h3>
<p>The News class is responsible for connecting to the WordPress API and collecting the latest published news. It also handles the storage of news in the database. The get_news method provides the processed news with the most important fields in JSON format.</p>
<h4 id="incialization_1">Incialization</h4>
<p>The <strong>init</strong> method serves as the constructor for a class. It connects to a WordPress API and a database, and if the connections are successful, it returns True. However, if there is an error connecting to the WordPress API or with the database, it prints an error message and returns a dictionary with a "success" key set to False. The method initializes the necessary connections and returns an indicator of success or failure.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span>
<span class="normal"><a href="#__codelineno-12-2">2</a></span>
<span class="normal"><a href="#__codelineno-12-3">3</a></span>
<span class="normal"><a href="#__codelineno-12-4">4</a></span>
<span class="normal"><a href="#__codelineno-12-5">5</a></span>
<span class="normal"><a href="#__codelineno-12-6">6</a></span>
<span class="normal"><a href="#__codelineno-12-7">7</a></span>
<span class="normal"><a href="#__codelineno-12-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a>            <span class="n">response</span>    <span class="o">=</span>   <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://infoamazonia.org/wp-json/wp/v2/posts&quot;</span><span class="p">)</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a>            <span class="n">response</span>    <span class="o">=</span>   <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://plenamata.eco/wp-json/wp/v2/posts&quot;</span><span class="p">)</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">db</span>     <span class="o">=</span>   <span class="n">dataBase</span><span class="o">.</span><span class="n">DataBase</span><span class="p">(</span><span class="s2">&quot;db/db.json&quot;</span><span class="p">)</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a>        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error connecting to Wordpress API&quot;</span><span class="p">)</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="get-news">Get news</h4>
<p>The get_news method retrieves the latest news from multiple APIs and returns a list of preprocessed JSON objects containing the most relevant fields. It iterates over a list of API sources, their URLs, and language preferences. The method sends requests to each API, retrieves the response, and extracts the necessary information from the JSON data. It handles pagination if applicable and populates the news dictionary with details such as ID, collection date, location, title, published date, author, description, URL, site, subtopics, keywords, language, and news source. It checks for duplicate news entries and filters out already existing news by comparing the title, URL, and ID with the database records. The method assigns the news source, fetches topics associated with the news, and appends the news to the documents list. Finally, the method returns a dictionary with the success status, the list of news documents, and the total number of news items.
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">  1</a></span>
<span class="normal"><a href="#__codelineno-13-2">  2</a></span>
<span class="normal"><a href="#__codelineno-13-3">  3</a></span>
<span class="normal"><a href="#__codelineno-13-4">  4</a></span>
<span class="normal"><a href="#__codelineno-13-5">  5</a></span>
<span class="normal"><a href="#__codelineno-13-6">  6</a></span>
<span class="normal"><a href="#__codelineno-13-7">  7</a></span>
<span class="normal"><a href="#__codelineno-13-8">  8</a></span>
<span class="normal"><a href="#__codelineno-13-9">  9</a></span>
<span class="normal"><a href="#__codelineno-13-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-13-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-13-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-13-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-13-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-13-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-13-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-13-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-13-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-13-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-13-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-13-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-13-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-13-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-13-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-13-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-13-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-13-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-13-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-13-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-13-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-13-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-13-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-13-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-13-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-13-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-13-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-13-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-13-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-13-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-13-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-13-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-13-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-13-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-13-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-13-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-13-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-13-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-13-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-13-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-13-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-13-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-13-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-13-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-13-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-13-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-13-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-13-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-13-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-13-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-13-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-13-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-13-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-13-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-13-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-13-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-13-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-13-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-13-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-13-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-13-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-13-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-13-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-13-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-13-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-13-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-13-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-13-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-13-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-13-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-13-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-13-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-13-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-13-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-13-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-13-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-13-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-13-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-13-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-13-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-13-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-13-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-13-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-13-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-13-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-13-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-13-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-13-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-13-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-13-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-13-100">100</a></span>
<span class="normal"><a href="#__codelineno-13-101">101</a></span>
<span class="normal"><a href="#__codelineno-13-102">102</a></span>
<span class="normal"><a href="#__codelineno-13-103">103</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a>    <span class="k">def</span> <span class="nf">get_news</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a>        <span class="n">apis</span><span class="o">=</span><span class="p">[]</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>        <span class="n">apis</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;api_source&quot;</span><span class="p">:</span><span class="s2">&quot;infoamazonia_pt&quot;</span><span class="p">,</span><span class="s2">&quot;lang&quot;</span><span class="p">:</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;api_url&quot;</span><span class="p">:</span><span class="s2">&quot;https://infoamazonia.org/wp-json/wp/v2/posts&quot;</span><span class="p">})</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>        <span class="n">apis</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;api_source&quot;</span><span class="p">:</span><span class="s2">&quot;infoamazonia_en&quot;</span><span class="p">,</span><span class="s2">&quot;lang&quot;</span><span class="p">:</span><span class="s2">&quot;en&quot;</span><span class="p">,</span> <span class="s2">&quot;api_url&quot;</span><span class="p">:</span><span class="s2">&quot;https://infoamazonia.org/en/wp-json/wp/v2/posts&quot;</span><span class="p">})</span>      
<a id="__codelineno-13-5" name="__codelineno-13-5"></a>        <span class="n">apis</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;api_source&quot;</span><span class="p">:</span><span class="s2">&quot;infoamazonia_es&quot;</span><span class="p">,</span><span class="s2">&quot;lang&quot;</span><span class="p">:</span><span class="s2">&quot;es&quot;</span><span class="p">,</span> <span class="s2">&quot;api_url&quot;</span><span class="p">:</span><span class="s2">&quot;https://infoamazonia.org/es/wp-json/wp/v2/posts&quot;</span><span class="p">})</span>      
<a id="__codelineno-13-6" name="__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a>        <span class="n">apis</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;api_source&quot;</span><span class="p">:</span><span class="s2">&quot;plenamata_pt&quot;</span><span class="p">,</span><span class="s2">&quot;lang&quot;</span><span class="p">:</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;api_url&quot;</span><span class="p">:</span><span class="s2">&quot;https://plenamata.eco/wp-json/wp/v2/posts&quot;</span><span class="p">})</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a>        <span class="n">apis</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;api_source&quot;</span><span class="p">:</span><span class="s2">&quot;plenamata_en&quot;</span><span class="p">,</span><span class="s2">&quot;lang&quot;</span><span class="p">:</span><span class="s2">&quot;en&quot;</span><span class="p">,</span> <span class="s2">&quot;api_url&quot;</span><span class="p">:</span><span class="s2">&quot;https://plenamata.eco/en/wp-json/wp/v2/posts&quot;</span><span class="p">})</span>        
<a id="__codelineno-13-9" name="__codelineno-13-9"></a>        <span class="n">apis</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;api_source&quot;</span><span class="p">:</span><span class="s2">&quot;plenamata_es&quot;</span><span class="p">,</span><span class="s2">&quot;lang&quot;</span><span class="p">:</span><span class="s2">&quot;es&quot;</span><span class="p">,</span> <span class="s2">&quot;api_url&quot;</span><span class="p">:</span><span class="s2">&quot;https://plenamata.eco/es/wp-json/wp/v2/posts&quot;</span><span class="p">})</span>        
<a id="__codelineno-13-10" name="__codelineno-13-10"></a>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a>        <span class="n">documents</span>   <span class="o">=</span>   <span class="p">[]</span>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a>        <span class="k">for</span>  <span class="n">api</span> <span class="ow">in</span> <span class="n">apis</span><span class="p">:</span>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a>            <span class="n">api_source</span>  <span class="o">=</span>   <span class="n">api</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_source&quot;</span><span class="p">)</span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a>            <span class="n">api_url</span>     <span class="o">=</span>   <span class="n">api</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_url&quot;</span><span class="p">)</span>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a>            <span class="n">lang</span>        <span class="o">=</span>   <span class="n">api</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lang&quot;</span><span class="p">)</span>     
<a id="__codelineno-13-17" name="__codelineno-13-17"></a>            <span class="n">response</span>    <span class="o">=</span>   <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">)</span>
<a id="__codelineno-13-18" name="__codelineno-13-18"></a>            <span class="n">headers</span>     <span class="o">=</span>   <span class="n">response</span><span class="o">.</span><span class="n">headers</span>
<a id="__codelineno-13-19" name="__codelineno-13-19"></a>
<a id="__codelineno-13-20" name="__codelineno-13-20"></a>            <span class="n">number_of_pages</span> <span class="o">=</span>    <span class="nb">int</span><span class="p">(</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-WP-TotalPages&#39;</span><span class="p">))</span>
<a id="__codelineno-13-21" name="__codelineno-13-21"></a>            <span class="n">number_of_posts</span> <span class="o">=</span>   <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-WP-Total&#39;</span><span class="p">)</span>
<a id="__codelineno-13-22" name="__codelineno-13-22"></a>            <span class="n">number_of_pages</span> <span class="o">=</span>   <span class="mi">1</span>       
<a id="__codelineno-13-23" name="__codelineno-13-23"></a>            <span class="n">stop_update</span>     <span class="o">=</span>   <span class="kc">False</span>
<a id="__codelineno-13-24" name="__codelineno-13-24"></a>
<a id="__codelineno-13-25" name="__codelineno-13-25"></a>            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">number_of_pages</span><span class="p">)):</span>
<a id="__codelineno-13-26" name="__codelineno-13-26"></a>                <span class="k">if</span> <span class="n">stop_update</span><span class="p">:</span>
<a id="__codelineno-13-27" name="__codelineno-13-27"></a>                    <span class="k">break</span>
<a id="__codelineno-13-28" name="__codelineno-13-28"></a>
<a id="__codelineno-13-29" name="__codelineno-13-29"></a>                <span class="n">api_url_page</span>    <span class="o">=</span>   <span class="n">api_url</span><span class="o">+</span><span class="s2">&quot;?_embed=wp:term?per_page=100&amp;page=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-13-30" name="__codelineno-13-30"></a>                <span class="n">response</span>        <span class="o">=</span>   <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url_page</span><span class="p">)</span>
<a id="__codelineno-13-31" name="__codelineno-13-31"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;API: &quot;</span><span class="o">+</span><span class="n">api_source</span><span class="p">,</span><span class="s2">&quot; Page </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-13-32" name="__codelineno-13-32"></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
<a id="__codelineno-13-33" name="__codelineno-13-33"></a>                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()):</span>
<a id="__codelineno-13-34" name="__codelineno-13-34"></a>                        <span class="c1">#if idx==1:</span>
<a id="__codelineno-13-35" name="__codelineno-13-35"></a>                        <span class="c1">#   break</span>
<a id="__codelineno-13-36" name="__codelineno-13-36"></a>                        <span class="c1">#print(&quot;*&quot;*100)</span>
<a id="__codelineno-13-37" name="__codelineno-13-37"></a>                        <span class="c1">#print()</span>
<a id="__codelineno-13-38" name="__codelineno-13-38"></a>                        <span class="c1">#pp.pprint(item)</span>
<a id="__codelineno-13-39" name="__codelineno-13-39"></a>                        <span class="c1">#print()            </span>
<a id="__codelineno-13-40" name="__codelineno-13-40"></a>                        <span class="c1">#print(&quot;*&quot;*100)         </span>
<a id="__codelineno-13-41" name="__codelineno-13-41"></a>                        <span class="n">news</span>                    <span class="o">=</span>   <span class="p">{}</span>
<a id="__codelineno-13-42" name="__codelineno-13-42"></a>                        <span class="n">meta</span>                    <span class="o">=</span>   <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;meta&quot;</span><span class="p">)</span>
<a id="__codelineno-13-43" name="__codelineno-13-43"></a>                        <span class="n">location</span>                <span class="o">=</span>   <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_related_point&quot;</span><span class="p">)</span>
<a id="__codelineno-13-44" name="__codelineno-13-44"></a>                        <span class="n">location_dict</span>           <span class="o">=</span>   <span class="p">{}</span>
<a id="__codelineno-13-45" name="__codelineno-13-45"></a>                        <span class="n">news</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span>         <span class="o">=</span>   <span class="kc">True</span>
<a id="__codelineno-13-46" name="__codelineno-13-46"></a>                        <span class="n">news</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>             <span class="o">=</span>   <span class="n">api_source</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">))</span>
<a id="__codelineno-13-47" name="__codelineno-13-47"></a>                        <span class="n">news</span><span class="p">[</span><span class="s2">&quot;collection_date&quot;</span><span class="p">]</span> <span class="o">=</span>   <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;America/Sao_Paulo&#39;</span><span class="p">))</span>
<a id="__codelineno-13-48" name="__codelineno-13-48"></a>                        <span class="k">if</span> <span class="n">location</span><span class="p">:</span>
<a id="__codelineno-13-49" name="__codelineno-13-49"></a>                            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-13-50" name="__codelineno-13-50"></a>                                <span class="n">location_dict</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>       <span class="o">=</span>   <span class="kc">True</span>
<a id="__codelineno-13-51" name="__codelineno-13-51"></a>                                <span class="n">location_dict</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span>            <span class="o">=</span>   <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_geocode_lat&#39;</span><span class="p">)</span>
<a id="__codelineno-13-52" name="__codelineno-13-52"></a>                                <span class="n">location_dict</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span>            <span class="o">=</span>   <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_geocode_lon&#39;</span><span class="p">)</span>
<a id="__codelineno-13-53" name="__codelineno-13-53"></a>
<a id="__codelineno-13-54" name="__codelineno-13-54"></a>                                <span class="n">location_dict</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span>        <span class="o">=</span>   <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_geocode_country&quot;</span><span class="p">)</span> 
<a id="__codelineno-13-55" name="__codelineno-13-55"></a>                                <span class="n">location_dict</span><span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>         <span class="o">=</span>   <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_geocode_region_level_1&#39;</span><span class="p">)</span>
<a id="__codelineno-13-56" name="__codelineno-13-56"></a>                                <span class="n">location_dict</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span>          <span class="o">=</span>   <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_geocode_region_level_2&#39;</span><span class="p">)</span>
<a id="__codelineno-13-57" name="__codelineno-13-57"></a>                                <span class="n">location_dict</span><span class="p">[</span><span class="s1">&#39;metropolitan&#39;</span><span class="p">]</span>   <span class="o">=</span>   <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_geocode_region_level_3&#39;</span><span class="p">)</span>
<a id="__codelineno-13-58" name="__codelineno-13-58"></a>                                <span class="n">location_dict</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span>           <span class="o">=</span>   <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_geocode_city&quot;</span><span class="p">)</span>
<a id="__codelineno-13-59" name="__codelineno-13-59"></a>                                <span class="n">location_dict</span><span class="p">[</span><span class="s1">&#39;city_region&#39;</span><span class="p">]</span>    <span class="o">=</span>   <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_geocode_city_level_1&quot;</span><span class="p">)</span>    
<a id="__codelineno-13-60" name="__codelineno-13-60"></a>                                <span class="n">location_dict</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]</span>        <span class="o">=</span>   <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_geocode_full_address&#39;</span><span class="p">)</span>
<a id="__codelineno-13-61" name="__codelineno-13-61"></a>                            <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-13-62" name="__codelineno-13-62"></a>                                <span class="n">location_dict</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>       <span class="o">=</span>   <span class="kc">False</span>
<a id="__codelineno-13-63" name="__codelineno-13-63"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-13-64" name="__codelineno-13-64"></a>                            <span class="n">location_dict</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>           <span class="o">=</span>   <span class="kc">False</span>
<a id="__codelineno-13-65" name="__codelineno-13-65"></a>
<a id="__codelineno-13-66" name="__codelineno-13-66"></a>                        <span class="n">news</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">location_dict</span>
<a id="__codelineno-13-67" name="__codelineno-13-67"></a>
<a id="__codelineno-13-68" name="__codelineno-13-68"></a>
<a id="__codelineno-13-69" name="__codelineno-13-69"></a>                        <span class="k">if</span><span class="p">(</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;yoast_head_json&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">()))):</span>                   
<a id="__codelineno-13-70" name="__codelineno-13-70"></a>                            <span class="n">yoast</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;yoast_head_json&#39;</span><span class="p">)</span> 
<a id="__codelineno-13-71" name="__codelineno-13-71"></a>
<a id="__codelineno-13-72" name="__codelineno-13-72"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">__check_news_field</span><span class="p">(</span><span class="n">yoast</span><span class="p">,</span><span class="n">news</span><span class="p">,</span><span class="s2">&quot;og_title&quot;</span><span class="p">,</span><span class="s2">&quot;Title&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-13-73" name="__codelineno-13-73"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">__check_news_field</span><span class="p">(</span><span class="n">yoast</span><span class="p">,</span><span class="n">news</span><span class="p">,</span><span class="s2">&quot;article_published_time&quot;</span><span class="p">,</span><span class="s2">&quot;Published_date&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>                    
<a id="__codelineno-13-74" name="__codelineno-13-74"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">__check_news_field</span><span class="p">(</span><span class="n">yoast</span><span class="p">,</span><span class="n">news</span><span class="p">,</span><span class="s2">&quot;author&quot;</span><span class="p">,</span><span class="s2">&quot;Author&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>                
<a id="__codelineno-13-75" name="__codelineno-13-75"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">__check_news_field</span><span class="p">(</span><span class="n">yoast</span><span class="p">,</span><span class="n">news</span><span class="p">,</span><span class="s2">&quot;description&quot;</span><span class="p">,</span><span class="s2">&quot;Description&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-13-76" name="__codelineno-13-76"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">__check_news_field</span><span class="p">(</span><span class="n">yoast</span><span class="p">,</span><span class="n">news</span><span class="p">,</span><span class="s2">&quot;og_url&quot;</span><span class="p">,</span><span class="s2">&quot;URL&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-13-77" name="__codelineno-13-77"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">__check_news_field</span><span class="p">(</span><span class="n">yoast</span><span class="p">,</span><span class="n">news</span><span class="p">,</span><span class="s2">&quot;og_site_name&quot;</span><span class="p">,</span><span class="s2">&quot;site&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-13-78" name="__codelineno-13-78"></a>
<a id="__codelineno-13-79" name="__codelineno-13-79"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">__check_news_field</span><span class="p">(</span><span class="n">yoast</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;@graph&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">news</span><span class="p">,</span><span class="s2">&quot;articleSection&quot;</span><span class="p">,</span><span class="s2">&quot;Subtopics&quot;</span><span class="p">,[])</span>
<a id="__codelineno-13-80" name="__codelineno-13-80"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">__check_news_field</span><span class="p">(</span><span class="n">yoast</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;@graph&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">news</span><span class="p">,</span><span class="s2">&quot;keywords&quot;</span><span class="p">,</span><span class="s2">&quot;Keywords&quot;</span><span class="p">,[])</span>
<a id="__codelineno-13-81" name="__codelineno-13-81"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">__check_news_field</span><span class="p">(</span><span class="n">yoast</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;@graph&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">news</span><span class="p">,</span><span class="s2">&quot;inLanguage&quot;</span><span class="p">,</span><span class="s2">&quot;Language&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>                       
<a id="__codelineno-13-82" name="__codelineno-13-82"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">__set_source</span><span class="p">(</span><span class="n">news</span><span class="p">)</span>
<a id="__codelineno-13-83" name="__codelineno-13-83"></a>
<a id="__codelineno-13-84" name="__codelineno-13-84"></a>                            <span class="k">if</span> <span class="n">news</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
<a id="__codelineno-13-85" name="__codelineno-13-85"></a>                                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_last_n_doc</span><span class="p">(</span><span class="s2">&quot;news&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;$or&quot;</span><span class="p">:[</span> <span class="p">{</span><span class="s2">&quot;Title&quot;</span><span class="p">:{</span> <span class="s2">&quot;$eq&quot;</span><span class="p">:</span><span class="n">news</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">]}},</span> <span class="p">{</span><span class="s2">&quot;URL&quot;</span><span class="p">:{</span> <span class="s2">&quot;$eq&quot;</span><span class="p">:</span> <span class="n">news</span><span class="p">[</span><span class="s1">&#39;URL&#39;</span><span class="p">]}</span> <span class="p">},{</span><span class="s2">&quot;_id&quot;</span><span class="p">:{</span> <span class="s2">&quot;$eq&quot;</span><span class="p">:</span> <span class="n">news</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span> <span class="p">}}]},</span> <span class="p">{</span><span class="s2">&quot;Title&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;URL&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">[(</span><span class="s1">&#39;Published_date&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)],</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-13-86" name="__codelineno-13-86"></a>                                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
<a id="__codelineno-13-87" name="__codelineno-13-87"></a>                                    <span class="n">stop_update</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-13-88" name="__codelineno-13-88"></a>                                    <span class="k">break</span>
<a id="__codelineno-13-89" name="__codelineno-13-89"></a>
<a id="__codelineno-13-90" name="__codelineno-13-90"></a>                                <span class="nb">print</span><span class="p">(</span><span class="n">api_source</span><span class="p">,</span><span class="n">news</span><span class="p">[</span><span class="s1">&#39;URL&#39;</span><span class="p">])</span>
<a id="__codelineno-13-91" name="__codelineno-13-91"></a>                                <span class="n">news</span><span class="p">[</span><span class="s2">&quot;api_source&quot;</span><span class="p">]</span>  <span class="o">=</span>   <span class="n">api_source</span>
<a id="__codelineno-13-92" name="__codelineno-13-92"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">__get_topics</span><span class="p">(</span><span class="n">news</span><span class="p">)</span>
<a id="__codelineno-13-93" name="__codelineno-13-93"></a>                                <span class="n">documents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">news</span><span class="p">)</span>  
<a id="__codelineno-13-94" name="__codelineno-13-94"></a>
<a id="__codelineno-13-95" name="__codelineno-13-95"></a>
<a id="__codelineno-13-96" name="__codelineno-13-96"></a>
<a id="__codelineno-13-97" name="__codelineno-13-97"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-13-98" name="__codelineno-13-98"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;news&quot;</span><span class="p">:</span><span class="n">documents</span><span class="p">,</span> <span class="s2">&quot;number_of_news&quot;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">documents</span><span class="p">)}</span>
<a id="__codelineno-13-99" name="__codelineno-13-99"></a>        <span class="k">else</span><span class="p">:</span>   
<a id="__codelineno-13-100" name="__codelineno-13-100"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">}</span>        
<a id="__codelineno-13-101" name="__codelineno-13-101"></a>
<a id="__codelineno-13-102" name="__codelineno-13-102"></a>
<a id="__codelineno-13-103" name="__codelineno-13-103"></a>        <span class="k">return</span> <span class="n">documents</span>                        
</code></pre></div></td></tr></table></div></p>
<h4 id="get-the-news-source-url">Get the news source URL</h4>
<p>The __set_source method sets the news_source attribute based on the news URL. If the URL contains "infoamazonia.org", it assigns the value "infoamazonia.org" to the news_source attribute. If the URL contains "plenamata.eco", it assigns the value "plenamata.eco" to the news_source attribute. Otherwise, it sets the news_source attribute to an empty string and marks the success attribute of the news as False.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span>
<span class="normal"><a href="#__codelineno-14-3">3</a></span>
<span class="normal"><a href="#__codelineno-14-4">4</a></span>
<span class="normal"><a href="#__codelineno-14-5">5</a></span>
<span class="normal"><a href="#__codelineno-14-6">6</a></span>
<span class="normal"><a href="#__codelineno-14-7">7</a></span>
<span class="normal"><a href="#__codelineno-14-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a>    <span class="k">def</span> <span class="nf">__set_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">news</span><span class="p">):</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a>        <span class="k">if</span> <span class="s2">&quot;//infoamazonia.org/&quot;</span> <span class="ow">in</span> <span class="n">news</span><span class="p">[</span><span class="s2">&quot;URL&quot;</span><span class="p">]:</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a>            <span class="n">news</span><span class="p">[</span><span class="s2">&quot;news_source&quot;</span><span class="p">]</span> <span class="o">=</span><span class="s2">&quot;infoamazonia.org&quot;</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>        <span class="k">elif</span> <span class="s2">&quot;//plenamata.eco/&quot;</span> <span class="ow">in</span> <span class="n">news</span><span class="p">[</span><span class="s2">&quot;URL&quot;</span><span class="p">]:</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a>            <span class="n">news</span><span class="p">[</span><span class="s2">&quot;news_source&quot;</span><span class="p">]</span> <span class="o">=</span><span class="s2">&quot;plenamata.eco&quot;</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a>            <span class="n">news</span><span class="p">[</span><span class="s2">&quot;news_source&quot;</span><span class="p">]</span> <span class="o">=</span><span class="s2">&quot;&quot;</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a>            <span class="n">news</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span>   <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
<h4 id="validate-a-news">Validate a news</h4>
<p>The __check_news_field method validates and retrieves important fields from an api_dict, assigning them to corresponding fields in the news dictionary, while handling exceptions and setting the  success attribute is appropriately set.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a>    <span class="k">def</span> <span class="nf">__check_news_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">api_dict</span><span class="p">,</span><span class="n">news</span><span class="p">,</span><span class="n">field</span><span class="p">,</span><span class="n">field_name</span><span class="p">,</span><span class="n">empty</span><span class="p">):</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a>            <span class="n">news</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span>  <span class="n">api_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>         
<a id="__codelineno-15-4" name="__codelineno-15-4"></a>            <span class="k">if</span>  <span class="ow">not</span> <span class="n">news</span><span class="p">[</span><span class="n">field_name</span><span class="p">]:</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a>                <span class="n">news</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>    <span class="o">=</span>   <span class="n">empty</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a>                <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">field</span><span class="o">==</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">field</span><span class="o">==</span><span class="s2">&quot;description&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">field</span><span class="o">==</span><span class="s2">&quot;URL&quot;</span><span class="p">)</span> <span class="p">):</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a>                    <span class="n">news</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span>   <span class="kc">False</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-15-10" name="__codelineno-15-10"></a>            <span class="nb">print</span><span class="p">(</span><span class="n">field</span><span class="o">+</span><span class="s2">&quot; exception&quot;</span><span class="p">)</span>
<a id="__codelineno-15-11" name="__codelineno-15-11"></a>            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-15-12" name="__codelineno-15-12"></a>            <span class="n">news</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>    <span class="o">=</span>   <span class="n">empty</span>
<a id="__codelineno-15-13" name="__codelineno-15-13"></a>            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">field</span><span class="o">==</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">field</span><span class="o">==</span><span class="s2">&quot;description&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">field</span><span class="o">==</span><span class="s2">&quot;URL&quot;</span><span class="p">)</span> <span class="p">):</span>
<a id="__codelineno-15-14" name="__codelineno-15-14"></a>                <span class="n">news</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span>   <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
<h4 id="getting-topics-of-the-news">Getting topics of the news</h4>
<p>The __get_topics method assigns a single topic to a news article based on its subtopics. It defines sets of topics related to environmental damage, protected areas, communities, climate change, conservation, and politics/economy. The method checks the intersection between the news article's subtopics and these predefined sets to determine the appropriate topic(s) for the article. The identified topics are stored in the News_topics field of the news dictionary. If an exception occurs during the process, an empty list is assigned to News_topics.
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span>
<span class="normal"><a href="#__codelineno-16-20">20</a></span>
<span class="normal"><a href="#__codelineno-16-21">21</a></span>
<span class="normal"><a href="#__codelineno-16-22">22</a></span>
<span class="normal"><a href="#__codelineno-16-23">23</a></span>
<span class="normal"><a href="#__codelineno-16-24">24</a></span>
<span class="normal"><a href="#__codelineno-16-25">25</a></span>
<span class="normal"><a href="#__codelineno-16-26">26</a></span>
<span class="normal"><a href="#__codelineno-16-27">27</a></span>
<span class="normal"><a href="#__codelineno-16-28">28</a></span>
<span class="normal"><a href="#__codelineno-16-29">29</a></span>
<span class="normal"><a href="#__codelineno-16-30">30</a></span>
<span class="normal"><a href="#__codelineno-16-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a>    <span class="k">def</span> <span class="nf">__get_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">news</span><span class="p">):</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a>        <span class="n">danos_ambientais</span>    <span class="o">=</span>   <span class="nb">set</span><span class="p">(</span>    <span class="p">[</span><span class="s2">&quot;Desmatamento&quot;</span><span class="p">,</span><span class="s2">&quot;Queimadas&quot;</span><span class="p">,</span><span class="s2">&quot;Garimpo&quot;</span><span class="p">,</span><span class="s2">&quot;Mineração&quot;</span><span class="p">,</span><span class="s2">&quot;Grilagem&quot;</span><span class="p">,</span><span class="s2">&quot;Agronegócio&quot;</span><span class="p">,</span><span class="s2">&quot;Agropecuária&quot;</span><span class="p">,</span><span class="s2">&quot;Madeira&quot;</span><span class="p">,</span><span class="s2">&quot;Poluição&quot;</span><span class="p">,</span><span class="s2">&quot;Petróleo&quot;</span><span class="p">,</span><span class="s2">&quot;Pecuária&quot;</span><span class="p">,</span><span class="s2">&quot;Crime ambiental&quot;</span><span class="p">,</span><span class="s2">&quot;Estradas&quot;</span><span class="p">,</span><span class="s2">&quot;Água&quot;</span><span class="p">,</span><span class="s2">&quot;Hidrelétricas&quot;</span><span class="p">,</span><span class="s2">&quot;Sistemas de Monitoramento&quot;</span><span class="p">])</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a>        <span class="n">areas_Protegidas</span>    <span class="o">=</span>   <span class="nb">set</span><span class="p">(</span>    <span class="p">[</span><span class="s2">&quot;Áreas Protegidas&quot;</span><span class="p">,</span><span class="s2">&quot;Unidades de Conservação&quot;</span><span class="p">,</span><span class="s2">&quot;Terras indígenas&quot;</span><span class="p">,</span><span class="s2">&quot;Pantanal&quot;</span><span class="p">,</span><span class="s2">&quot;Questão fundiária&quot;</span><span class="p">,</span><span class="s2">&quot;Indígenas&quot;</span><span class="p">])</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a>        <span class="n">Povos</span>               <span class="o">=</span>   <span class="nb">set</span><span class="p">(</span>    <span class="p">[</span><span class="s2">&quot;Cultura&quot;</span><span class="p">,</span><span class="s2">&quot;Covid-19&quot;</span><span class="p">,</span><span class="s2">&quot;Saúde&quot;</span><span class="p">,</span><span class="s2">&quot;Defensores ambientais&quot;</span><span class="p">,</span><span class="s2">&quot;Memória&quot;</span><span class="p">,</span><span class="s2">&quot;Quilombolas&quot;</span><span class="p">,</span><span class="s2">&quot;Mulher&quot;</span><span class="p">,</span><span class="s2">&quot;Emigrar&quot;</span><span class="p">,</span><span class="s2">&quot;Educação&quot;</span><span class="p">,</span><span class="s2">&quot;Paz e Guerra&quot;</span><span class="p">,</span><span class="s2">&quot;Religião&quot;</span><span class="p">,</span><span class="s2">&quot;Indígenas&quot;</span><span class="p">])</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a>        <span class="n">mudanca_climatica</span>   <span class="o">=</span>   <span class="nb">set</span><span class="p">(</span>    <span class="p">[</span><span class="s2">&quot;Mudança climática&quot;</span><span class="p">,</span><span class="s2">&quot;Crédito de carbono&quot;</span><span class="p">,</span><span class="s2">&quot;COP27&quot;</span><span class="p">,</span><span class="s2">&quot;COP&quot;</span><span class="p">])</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a>        <span class="n">conservacao</span>         <span class="o">=</span>   <span class="nb">set</span><span class="p">(</span>    <span class="p">[</span><span class="s2">&quot;Biodiversidade&quot;</span><span class="p">,</span><span class="s2">&quot;Ciência&quot;</span><span class="p">,</span><span class="s2">&quot;Sistemas de Monitoramento&quot;</span><span class="p">,</span><span class="s2">&quot;Conservação&quot;</span><span class="p">,</span><span class="s2">&quot;Regeneração&quot;</span><span class="p">])</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a>        <span class="n">politica_economia</span>   <span class="o">=</span>   <span class="nb">set</span><span class="p">(</span>    <span class="p">[</span><span class="s2">&quot;Sustentabilidade&quot;</span><span class="p">,</span><span class="s2">&quot;Política&quot;</span><span class="p">,</span><span class="s2">&quot;Política pública&quot;</span><span class="p">,</span><span class="s2">&quot;Bioeconomia&quot;</span><span class="p">,</span><span class="s2">&quot;Eleições 2022&quot;</span><span class="p">,</span><span class="s2">&quot;Eleições&quot;</span><span class="p">,</span><span class="s2">&quot;Corrupção&quot;</span><span class="p">,</span><span class="s2">&quot;Produtos sustentáveis&quot;</span><span class="p">,</span><span class="s2">&quot;Milícia&quot;</span><span class="p">,</span><span class="s2">&quot;Congresso Nacional&quot;</span><span class="p">,</span><span class="s2">&quot;Supremo&quot;</span><span class="p">])</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a>            <span class="n">news_subtopics</span>  <span class="o">=</span>   <span class="nb">set</span><span class="p">(</span>    <span class="n">news</span><span class="p">[</span><span class="s1">&#39;Subtopics&#39;</span><span class="p">])</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a>            <span class="n">news_topics</span><span class="o">=</span><span class="p">[]</span>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a>            <span class="k">if</span> <span class="n">news_subtopics</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">danos_ambientais</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;plenamata&quot;</span> <span class="ow">in</span> <span class="n">news</span><span class="p">[</span><span class="s1">&#39;news_source&#39;</span><span class="p">]:</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a>                <span class="n">news_topics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;danos_ambientais&quot;</span><span class="p">)</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a>
<a id="__codelineno-16-14" name="__codelineno-16-14"></a>            <span class="k">if</span> <span class="n">news_subtopics</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">areas_Protegidas</span><span class="p">):</span>
<a id="__codelineno-16-15" name="__codelineno-16-15"></a>                <span class="n">news_topics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;areas_Protegidas&quot;</span><span class="p">)</span>
<a id="__codelineno-16-16" name="__codelineno-16-16"></a>
<a id="__codelineno-16-17" name="__codelineno-16-17"></a>            <span class="k">if</span> <span class="n">news_subtopics</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">Povos</span><span class="p">):</span>
<a id="__codelineno-16-18" name="__codelineno-16-18"></a>                <span class="n">news_topics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;povos&quot;</span><span class="p">)</span>
<a id="__codelineno-16-19" name="__codelineno-16-19"></a>
<a id="__codelineno-16-20" name="__codelineno-16-20"></a>            <span class="k">if</span> <span class="n">news_subtopics</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">mudanca_climatica</span><span class="p">):</span>
<a id="__codelineno-16-21" name="__codelineno-16-21"></a>                <span class="n">news_topics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;mudanca_climatica&quot;</span><span class="p">)</span>
<a id="__codelineno-16-22" name="__codelineno-16-22"></a>
<a id="__codelineno-16-23" name="__codelineno-16-23"></a>            <span class="k">if</span> <span class="n">news_subtopics</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">conservacao</span><span class="p">):</span>
<a id="__codelineno-16-24" name="__codelineno-16-24"></a>                <span class="n">news_topics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;conservacao&quot;</span><span class="p">)</span>
<a id="__codelineno-16-25" name="__codelineno-16-25"></a>
<a id="__codelineno-16-26" name="__codelineno-16-26"></a>            <span class="k">if</span> <span class="n">news_subtopics</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">politica_economia</span><span class="p">):</span>
<a id="__codelineno-16-27" name="__codelineno-16-27"></a>                <span class="n">news_topics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;politica_economia&quot;</span><span class="p">)</span>
<a id="__codelineno-16-28" name="__codelineno-16-28"></a>
<a id="__codelineno-16-29" name="__codelineno-16-29"></a>            <span class="n">news</span><span class="p">[</span><span class="s1">&#39;News_topics&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">news_topics</span>
<a id="__codelineno-16-30" name="__codelineno-16-30"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-16-31" name="__codelineno-16-31"></a>            <span class="n">news</span><span class="p">[</span><span class="s1">&#39;News_topics&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
</code></pre></div></td></tr></table></div></p>
<h3 id="whatsapp_client">whatsapp_client</h3>
<p>The Whatsapp_client class is responsible for the communication between the bot and the WhatsApp Business API. It processes user messages and responds to users based on their choices.</p>
<h4 id="dictionary-of-messages">Dictionary of messages</h4>
<p>This method returns the desired message based on the input attribute. </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">  1</a></span>
<span class="normal"><a href="#__codelineno-17-2">  2</a></span>
<span class="normal"><a href="#__codelineno-17-3">  3</a></span>
<span class="normal"><a href="#__codelineno-17-4">  4</a></span>
<span class="normal"><a href="#__codelineno-17-5">  5</a></span>
<span class="normal"><a href="#__codelineno-17-6">  6</a></span>
<span class="normal"><a href="#__codelineno-17-7">  7</a></span>
<span class="normal"><a href="#__codelineno-17-8">  8</a></span>
<span class="normal"><a href="#__codelineno-17-9">  9</a></span>
<span class="normal"><a href="#__codelineno-17-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-17-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-17-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-17-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-17-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-17-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-17-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-17-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-17-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-17-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-17-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-17-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-17-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-17-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-17-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-17-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-17-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-17-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-17-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-17-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-17-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-17-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-17-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-17-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-17-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-17-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-17-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-17-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-17-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-17-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-17-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-17-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-17-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-17-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-17-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-17-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-17-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-17-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-17-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-17-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-17-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-17-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-17-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-17-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-17-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-17-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-17-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-17-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-17-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-17-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-17-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-17-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-17-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-17-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-17-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-17-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-17-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-17-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-17-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-17-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-17-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-17-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-17-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-17-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-17-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-17-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-17-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-17-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-17-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-17-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-17-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-17-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-17-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-17-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-17-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-17-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-17-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-17-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-17-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-17-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-17-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-17-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-17-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-17-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-17-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-17-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-17-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-17-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-17-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-17-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-17-100">100</a></span>
<span class="normal"><a href="#__codelineno-17-101">101</a></span>
<span class="normal"><a href="#__codelineno-17-102">102</a></span>
<span class="normal"><a href="#__codelineno-17-103">103</a></span>
<span class="normal"><a href="#__codelineno-17-104">104</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a>    <span class="k">def</span> <span class="nf">get_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a>        <span class="n">welcome</span><span class="o">=</span><span class="s2">&quot;Boas vindas! Sou o robô de notícias da InfoAmazonia 🍃</span><span class="se">\n</span><span class="s2">Envio os conteúdos recém-publicados que mais te interessam sobre a Amazônia brasileira. O serviço é *GRATUITO*.</span><span class="se">\n\n</span><span class="s2">📌 Para voltar a ver estas opções, me envie *MENU* a qualquer momento.</span><span class="se">\n</span><span class="s2">📌 Se desejar parar de receber meus conteúdos, escreva *CANCELAR* a qualquer momento e não te mandarei mais notícias.&quot;</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a>        <span class="n">image</span>       <span class="o">=</span>   <span class="s2">&quot;Desculpe, mas eu ainda não consigo visualizar imagens. 😥</span><span class="se">\n</span><span class="s2">Por favor, escolha uma das opções! 😃&quot;</span>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a>        <span class="n">document</span>    <span class="o">=</span>   <span class="s2">&quot;Desculpe, mas eu ainda não consigo ler documentos. 😥</span><span class="se">\n</span><span class="s2">Por favor, escolha uma das opções! 😃&quot;</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a>        <span class="n">location</span>    <span class="o">=</span>   <span class="s2">&quot;Desculpe, mas eu ainda não entendo localizações compartilhadas. 😥</span><span class="se">\n</span><span class="s2">Por favor, escolha uma das opções! 😃&quot;</span>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a>        <span class="n">contacts</span>    <span class="o">=</span>   <span class="s2">&quot;Desculpe, mas eu ainda não reconheço contatos. 😥</span><span class="se">\n</span><span class="s2">Para compartilhar este serviço com amigos, por favor, peça que me escrevam diretamente! 😃&quot;</span>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a>        <span class="n">video</span>       <span class="o">=</span>   <span class="s2">&quot;Desculpe, mas eu ainda não consigo assistir vídeos. 😥</span><span class="se">\n</span><span class="s2">Por favor, escolha uma das opções! 😃&quot;</span>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a>        <span class="n">audio</span>       <span class="o">=</span>   <span class="s2">&quot;Desculpe, mas eu ainda não consigo escutar áudios. 😥</span><span class="se">\n</span><span class="s2">Por favor, escolha uma das opções! 😃&quot;</span>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a>        <span class="n">sticker</span>     <span class="o">=</span>   <span class="s2">&quot;Desculpe, mas eu ainda não consigo visualizar figurinhas. 😥</span><span class="se">\n</span><span class="s2">Por favor, escolha uma das opções! 😃&quot;</span>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a>        <span class="n">cancel_1</span>    <span class="o">=</span>   <span class="s2">&quot;Já cancelei sua inscrição e não enviarei novos conteúdos 😥. Se desejar voltar a receber, é só enviar *MENU*.&quot;</span>
<a id="__codelineno-17-14" name="__codelineno-17-14"></a>        <span class="n">cancel_0</span>    <span class="o">=</span>   <span class="s2">&quot;Eu já havia cancelado sua inscrição e você vai continuar sem receber novos conteúdos da InfoAmazonia 😥. Quando quiser voltar a receber, é só escrever *MENU*.&quot;</span>
<a id="__codelineno-17-15" name="__codelineno-17-15"></a>        <span class="n">all_content</span> <span class="o">=</span>   <span class="s2">&quot;Obrigado pela sua inscrição! 🙌 Em breve você começará a receber nosso conteúdo no seu WhatsApp 📲. Se quiser ver as opções outra vez, é só digitar *MENU*.&quot;</span>
<a id="__codelineno-17-16" name="__codelineno-17-16"></a>
<a id="__codelineno-17-17" name="__codelineno-17-17"></a>        <span class="n">about</span>       <span class="o">=</span>   <span class="s2">&quot;InfoAmazonia é um meio de comunicação que utiliza dados, mapas e reportagens geolocalizadas para revelar a importância global da maior floresta tropical do planeta. &quot;</span> 
<a id="__codelineno-17-18" name="__codelineno-17-18"></a>        <span class="n">about</span>       <span class="o">=</span>   <span class="n">about</span> <span class="o">+</span><span class="s2">&quot;Vislumbramos um mundo onde a informação e o conhecimento transformam a forma como nos relacionamos com os territórios amazônicos em toda a sua  diversidade, ampliando a compreensão do papel vital desempenhado pela  Amazônia por todos.&quot;</span>
<a id="__codelineno-17-19" name="__codelineno-17-19"></a>        <span class="n">about</span>       <span class="o">=</span>   <span class="n">about</span> <span class="o">+</span><span class="s2">&quot;Trazemos contexto e aprofundamento à cobertura jornalística, indo além das notícias imediatas e buscando compreender as causas dos temas reportados para fomentar o debate público e estimular ações transformadoras.&quot;</span>
<a id="__codelineno-17-20" name="__codelineno-17-20"></a>
<a id="__codelineno-17-21" name="__codelineno-17-21"></a>        <span class="n">main_menu</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-17-22" name="__codelineno-17-22"></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span>
<a id="__codelineno-17-23" name="__codelineno-17-23"></a>                    <span class="s2">&quot;header&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-17-24" name="__codelineno-17-24"></a>                      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-17-25" name="__codelineno-17-25"></a>                      <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Envio apenas os conteúdos do seu interesse.&quot;</span>
<a id="__codelineno-17-26" name="__codelineno-17-26"></a>                    <span class="p">},</span>
<a id="__codelineno-17-27" name="__codelineno-17-27"></a>                    <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-17-28" name="__codelineno-17-28"></a>                      <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Você quer ser informado sobre novos conteúdos de quais temas ou estados?&quot;</span>
<a id="__codelineno-17-29" name="__codelineno-17-29"></a>                    <span class="p">},</span>
<a id="__codelineno-17-30" name="__codelineno-17-30"></a>                    <span class="s2">&quot;footer&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-17-31" name="__codelineno-17-31"></a>                      <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Escolha uma das opções&quot;</span>
<a id="__codelineno-17-32" name="__codelineno-17-32"></a>                    <span class="p">},</span>
<a id="__codelineno-17-33" name="__codelineno-17-33"></a>                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-17-34" name="__codelineno-17-34"></a>                      <span class="s2">&quot;button&quot;</span><span class="p">:</span> <span class="s2">&quot;Toque aqui!&quot;</span><span class="p">,</span>
<a id="__codelineno-17-35" name="__codelineno-17-35"></a>                      <span class="s2">&quot;sections&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-17-36" name="__codelineno-17-36"></a>                        <span class="p">{</span>
<a id="__codelineno-17-37" name="__codelineno-17-37"></a>                          <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;personalize o conteúdo&quot;</span><span class="p">,</span>
<a id="__codelineno-17-38" name="__codelineno-17-38"></a>                          <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-17-39" name="__codelineno-17-39"></a>                            <span class="p">{</span>
<a id="__codelineno-17-40" name="__codelineno-17-40"></a>                              <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;MAIN_ALL_CONTENT&quot;</span><span class="p">,</span>
<a id="__codelineno-17-41" name="__codelineno-17-41"></a>                              <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Tudo&quot;</span><span class="p">,</span>
<a id="__codelineno-17-42" name="__codelineno-17-42"></a>                              <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Todos os conteúdos da InfoAmazonia 🌳&quot;</span>
<a id="__codelineno-17-43" name="__codelineno-17-43"></a>                            <span class="p">},</span>
<a id="__codelineno-17-44" name="__codelineno-17-44"></a>                            <span class="p">{</span>
<a id="__codelineno-17-45" name="__codelineno-17-45"></a>                              <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;MAIN_LOCATIONS&quot;</span><span class="p">,</span>
<a id="__codelineno-17-46" name="__codelineno-17-46"></a>                              <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Estados&quot;</span><span class="p">,</span>
<a id="__codelineno-17-47" name="__codelineno-17-47"></a>                              <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Escolha conteúdos sobre determinados estados 🇧🇷&quot;</span>
<a id="__codelineno-17-48" name="__codelineno-17-48"></a>                            <span class="p">},</span>
<a id="__codelineno-17-49" name="__codelineno-17-49"></a>                            <span class="p">{</span>
<a id="__codelineno-17-50" name="__codelineno-17-50"></a>                              <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;MAIN_TOPCIS&quot;</span><span class="p">,</span>
<a id="__codelineno-17-51" name="__codelineno-17-51"></a>                              <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Temas&quot;</span><span class="p">,</span>
<a id="__codelineno-17-52" name="__codelineno-17-52"></a>                              <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Escolha conteúdos sobre determinados temas ✅&quot;</span>
<a id="__codelineno-17-53" name="__codelineno-17-53"></a>                            <span class="p">},</span>
<a id="__codelineno-17-54" name="__codelineno-17-54"></a>                            <span class="p">{</span>
<a id="__codelineno-17-55" name="__codelineno-17-55"></a>                              <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;MAIN_ABOUT&quot;</span><span class="p">,</span>
<a id="__codelineno-17-56" name="__codelineno-17-56"></a>                              <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Sobre&quot;</span><span class="p">,</span>
<a id="__codelineno-17-57" name="__codelineno-17-57"></a>                              <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Saiba mais sobre a InfoAmazonia 🍃&quot;</span>
<a id="__codelineno-17-58" name="__codelineno-17-58"></a>                            <span class="p">},</span>
<a id="__codelineno-17-59" name="__codelineno-17-59"></a>                          <span class="p">]</span>
<a id="__codelineno-17-60" name="__codelineno-17-60"></a>                        <span class="p">}</span>
<a id="__codelineno-17-61" name="__codelineno-17-61"></a>
<a id="__codelineno-17-62" name="__codelineno-17-62"></a>                      <span class="p">]</span>
<a id="__codelineno-17-63" name="__codelineno-17-63"></a>                    <span class="p">}</span>
<a id="__codelineno-17-64" name="__codelineno-17-64"></a>                  <span class="p">}</span>
<a id="__codelineno-17-65" name="__codelineno-17-65"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">==</span><span class="s2">&quot;main_menu&quot;</span><span class="p">:</span>
<a id="__codelineno-17-66" name="__codelineno-17-66"></a>            <span class="k">return</span> <span class="n">main_menu</span>
<a id="__codelineno-17-67" name="__codelineno-17-67"></a>
<a id="__codelineno-17-68" name="__codelineno-17-68"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">==</span><span class="s2">&quot;welcome&quot;</span><span class="p">:</span>
<a id="__codelineno-17-69" name="__codelineno-17-69"></a>            <span class="k">return</span> <span class="n">welcome</span>
<a id="__codelineno-17-70" name="__codelineno-17-70"></a>
<a id="__codelineno-17-71" name="__codelineno-17-71"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">==</span><span class="s2">&quot;image&quot;</span><span class="p">:</span>
<a id="__codelineno-17-72" name="__codelineno-17-72"></a>            <span class="k">return</span> <span class="n">image</span>
<a id="__codelineno-17-73" name="__codelineno-17-73"></a>
<a id="__codelineno-17-74" name="__codelineno-17-74"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">==</span><span class="s2">&quot;document&quot;</span><span class="p">:</span>
<a id="__codelineno-17-75" name="__codelineno-17-75"></a>            <span class="k">return</span> <span class="n">document</span>
<a id="__codelineno-17-76" name="__codelineno-17-76"></a>
<a id="__codelineno-17-77" name="__codelineno-17-77"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">==</span><span class="s2">&quot;location&quot;</span><span class="p">:</span>
<a id="__codelineno-17-78" name="__codelineno-17-78"></a>            <span class="k">return</span> <span class="n">location</span>
<a id="__codelineno-17-79" name="__codelineno-17-79"></a>
<a id="__codelineno-17-80" name="__codelineno-17-80"></a>
<a id="__codelineno-17-81" name="__codelineno-17-81"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">==</span><span class="s2">&quot;contacts&quot;</span><span class="p">:</span>
<a id="__codelineno-17-82" name="__codelineno-17-82"></a>            <span class="k">return</span> <span class="n">contacts</span>                     
<a id="__codelineno-17-83" name="__codelineno-17-83"></a>
<a id="__codelineno-17-84" name="__codelineno-17-84"></a>
<a id="__codelineno-17-85" name="__codelineno-17-85"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">==</span><span class="s2">&quot;video&quot;</span><span class="p">:</span>
<a id="__codelineno-17-86" name="__codelineno-17-86"></a>            <span class="k">return</span> <span class="n">video</span>
<a id="__codelineno-17-87" name="__codelineno-17-87"></a>
<a id="__codelineno-17-88" name="__codelineno-17-88"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">==</span><span class="s2">&quot;audio&quot;</span><span class="p">:</span>
<a id="__codelineno-17-89" name="__codelineno-17-89"></a>            <span class="k">return</span> <span class="n">audio</span>            
<a id="__codelineno-17-90" name="__codelineno-17-90"></a>
<a id="__codelineno-17-91" name="__codelineno-17-91"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">==</span><span class="s2">&quot;sticker&quot;</span><span class="p">:</span>
<a id="__codelineno-17-92" name="__codelineno-17-92"></a>            <span class="k">return</span> <span class="n">sticker</span>      
<a id="__codelineno-17-93" name="__codelineno-17-93"></a>
<a id="__codelineno-17-94" name="__codelineno-17-94"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">==</span><span class="s2">&quot;cancel_0&quot;</span><span class="p">:</span>
<a id="__codelineno-17-95" name="__codelineno-17-95"></a>            <span class="k">return</span> <span class="n">cancel_0</span> 
<a id="__codelineno-17-96" name="__codelineno-17-96"></a>
<a id="__codelineno-17-97" name="__codelineno-17-97"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">==</span><span class="s2">&quot;cancel_1&quot;</span><span class="p">:</span>
<a id="__codelineno-17-98" name="__codelineno-17-98"></a>            <span class="k">return</span> <span class="n">cancel_1</span> 
<a id="__codelineno-17-99" name="__codelineno-17-99"></a>
<a id="__codelineno-17-100" name="__codelineno-17-100"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">==</span><span class="s2">&quot;ALL_CONTENT&quot;</span><span class="p">:</span>
<a id="__codelineno-17-101" name="__codelineno-17-101"></a>            <span class="k">return</span> <span class="n">all_content</span>  
<a id="__codelineno-17-102" name="__codelineno-17-102"></a>
<a id="__codelineno-17-103" name="__codelineno-17-103"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">==</span><span class="s2">&quot;about&quot;</span><span class="p">:</span>
<a id="__codelineno-17-104" name="__codelineno-17-104"></a>            <span class="k">return</span> <span class="n">about</span>                  
</code></pre></div></td></tr></table></div>
<h4 id="saving-the-state-of-conversation">Saving the state of conversation</h4>
<p>This method saves on database if the message was sent, deliverd or read</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a>    <span class="k">def</span> <span class="nf">save_conversation_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span><span class="n">message</span><span class="p">):</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a>        <span class="n">response_date</span>   <span class="o">=</span>   <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DATE&quot;</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">%a</span><span class="s1">, </span><span class="si">%d</span><span class="s1"> %b %Y %H:%M:%S GMT&#39;</span><span class="p">)</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a>        <span class="n">response</span>        <span class="o">=</span>   <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a>        <span class="n">user_id</span>         <span class="o">=</span>   <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;contacts&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wa_id&quot;</span><span class="p">)</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a>        <span class="n">wamid</span>           <span class="o">=</span>   <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  wamid$&gt;&quot;</span><span class="p">,</span><span class="n">wamid</span><span class="p">)</span>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a>        <span class="n">url</span>             <span class="o">=</span>   <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;URL&quot;</span><span class="p">)</span>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,[{</span><span class="s2">&quot;response_date&quot;</span><span class="p">:</span> <span class="n">response_date</span><span class="p">,</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">wamid</span><span class="p">,</span> <span class="s2">&quot;wamid&quot;</span><span class="p">:</span><span class="n">wamid</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;sent&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s2">&quot;delivered&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s2">&quot;read&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span><span class="n">url</span><span class="p">}])</span>
</code></pre></div></td></tr></table></div>
<h4 id="stories-message-template">Stories message template</h4>
<p>This method return  the json of the template</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span>
<span class="normal"><a href="#__codelineno-19-27">27</a></span>
<span class="normal"><a href="#__codelineno-19-28">28</a></span>
<span class="normal"><a href="#__codelineno-19-29">29</a></span>
<span class="normal"><a href="#__codelineno-19-30">30</a></span>
<span class="normal"><a href="#__codelineno-19-31">31</a></span>
<span class="normal"><a href="#__codelineno-19-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a>    <span class="k">def</span> <span class="nf">get_stories_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">payload</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a>        <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span>   <span class="p">{</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a>                                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;posts_stories&quot;</span><span class="p">,</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a>                                    <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a>                                      <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;pt_BR&quot;</span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a>                                    <span class="p">},</span>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a>                                    <span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a>                                      <span class="p">{</span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a>                                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;body&quot;</span><span class="p">,</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a>                                        <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a>                                          <span class="p">{</span>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a>                                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a>                                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Title&quot;</span><span class="p">)</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a>                                          <span class="p">},</span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a>                                          <span class="p">{</span>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a>                                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a>                                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">)</span>
<a id="__codelineno-19-18" name="__codelineno-19-18"></a>                                          <span class="p">},</span>
<a id="__codelineno-19-19" name="__codelineno-19-19"></a>                                           <span class="p">{</span>
<a id="__codelineno-19-20" name="__codelineno-19-20"></a>                                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-19-21" name="__codelineno-19-21"></a>                                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Author&quot;</span><span class="p">)</span>
<a id="__codelineno-19-22" name="__codelineno-19-22"></a>                                          <span class="p">},</span>
<a id="__codelineno-19-23" name="__codelineno-19-23"></a>                                          <span class="p">{</span>
<a id="__codelineno-19-24" name="__codelineno-19-24"></a>                                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-19-25" name="__codelineno-19-25"></a>                                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;URL&quot;</span><span class="p">)</span>
<a id="__codelineno-19-26" name="__codelineno-19-26"></a>                                          <span class="p">}</span>
<a id="__codelineno-19-27" name="__codelineno-19-27"></a>                                        <span class="p">]</span>
<a id="__codelineno-19-28" name="__codelineno-19-28"></a>                                      <span class="p">}</span>
<a id="__codelineno-19-29" name="__codelineno-19-29"></a>                                    <span class="p">]</span>
<a id="__codelineno-19-30" name="__codelineno-19-30"></a>                                  <span class="p">}</span>
<a id="__codelineno-19-31" name="__codelineno-19-31"></a>
<a id="__codelineno-19-32" name="__codelineno-19-32"></a>        <span class="k">return</span> <span class="n">payload</span>
</code></pre></div></td></tr></table></div>
<h4 id="opinion-message-template">Opinion message template</h4>
<p>This method return  the json of the template</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span>
<span class="normal"><a href="#__codelineno-20-17">17</a></span>
<span class="normal"><a href="#__codelineno-20-18">18</a></span>
<span class="normal"><a href="#__codelineno-20-19">19</a></span>
<span class="normal"><a href="#__codelineno-20-20">20</a></span>
<span class="normal"><a href="#__codelineno-20-21">21</a></span>
<span class="normal"><a href="#__codelineno-20-22">22</a></span>
<span class="normal"><a href="#__codelineno-20-23">23</a></span>
<span class="normal"><a href="#__codelineno-20-24">24</a></span>
<span class="normal"><a href="#__codelineno-20-25">25</a></span>
<span class="normal"><a href="#__codelineno-20-26">26</a></span>
<span class="normal"><a href="#__codelineno-20-27">27</a></span>
<span class="normal"><a href="#__codelineno-20-28">28</a></span>
<span class="normal"><a href="#__codelineno-20-29">29</a></span>
<span class="normal"><a href="#__codelineno-20-30">30</a></span>
<span class="normal"><a href="#__codelineno-20-31">31</a></span>
<span class="normal"><a href="#__codelineno-20-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a>    <span class="k">def</span> <span class="nf">get_opinion_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">payload</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a>        <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span>   <span class="p">{</span>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a>                                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;posts_opinion&quot;</span><span class="p">,</span>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a>                                    <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a>                                      <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;pt_BR&quot;</span>
<a id="__codelineno-20-6" name="__codelineno-20-6"></a>                                    <span class="p">},</span>
<a id="__codelineno-20-7" name="__codelineno-20-7"></a>                                    <span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a>                                      <span class="p">{</span>
<a id="__codelineno-20-9" name="__codelineno-20-9"></a>                                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;body&quot;</span><span class="p">,</span>
<a id="__codelineno-20-10" name="__codelineno-20-10"></a>                                        <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-20-11" name="__codelineno-20-11"></a>                                          <span class="p">{</span>
<a id="__codelineno-20-12" name="__codelineno-20-12"></a>                                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-20-13" name="__codelineno-20-13"></a>                                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Title&quot;</span><span class="p">)</span>
<a id="__codelineno-20-14" name="__codelineno-20-14"></a>                                          <span class="p">},</span>
<a id="__codelineno-20-15" name="__codelineno-20-15"></a>                                          <span class="p">{</span>
<a id="__codelineno-20-16" name="__codelineno-20-16"></a>                                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-20-17" name="__codelineno-20-17"></a>                                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">)</span>
<a id="__codelineno-20-18" name="__codelineno-20-18"></a>                                          <span class="p">},</span>
<a id="__codelineno-20-19" name="__codelineno-20-19"></a>                                           <span class="p">{</span>
<a id="__codelineno-20-20" name="__codelineno-20-20"></a>                                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-20-21" name="__codelineno-20-21"></a>                                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Author&quot;</span><span class="p">)</span>
<a id="__codelineno-20-22" name="__codelineno-20-22"></a>                                          <span class="p">},</span>
<a id="__codelineno-20-23" name="__codelineno-20-23"></a>                                          <span class="p">{</span>
<a id="__codelineno-20-24" name="__codelineno-20-24"></a>                                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-20-25" name="__codelineno-20-25"></a>                                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;URL&quot;</span><span class="p">)</span>
<a id="__codelineno-20-26" name="__codelineno-20-26"></a>                                          <span class="p">}</span>
<a id="__codelineno-20-27" name="__codelineno-20-27"></a>                                        <span class="p">]</span>
<a id="__codelineno-20-28" name="__codelineno-20-28"></a>                                      <span class="p">}</span>
<a id="__codelineno-20-29" name="__codelineno-20-29"></a>                                    <span class="p">]</span>
<a id="__codelineno-20-30" name="__codelineno-20-30"></a>                                  <span class="p">}</span>
<a id="__codelineno-20-31" name="__codelineno-20-31"></a>
<a id="__codelineno-20-32" name="__codelineno-20-32"></a>        <span class="k">return</span> <span class="n">payload</span>
</code></pre></div></td></tr></table></div>
<h4 id="sending-a-message">Sending a message</h4>
<p>This method is responsible for sending a WhatsApp message to the user. It takes parameters such as the recipient's phone number, message type, and the actual message content. The method constructs a payload with the necessary information and determines the appropriate message type based on the input. If the message type is "text", the payload is set accordingly with the text body. For "interactive" messages, the payload includes the interactive message content. In the case of "stories" or "opinion" message types, the payload is modified by calling helper methods to generate the appropriate templates. The method then makes a POST request to the WhatsApp API's messages endpoint, passing the payload as JSON data. If the response status code is 200 (indicating a successful request), the method may save the conversation state and returns the response. Otherwise, it prints the response JSON and waits briefly before returning the response.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span>
<span class="normal"><a href="#__codelineno-21-12">12</a></span>
<span class="normal"><a href="#__codelineno-21-13">13</a></span>
<span class="normal"><a href="#__codelineno-21-14">14</a></span>
<span class="normal"><a href="#__codelineno-21-15">15</a></span>
<span class="normal"><a href="#__codelineno-21-16">16</a></span>
<span class="normal"><a href="#__codelineno-21-17">17</a></span>
<span class="normal"><a href="#__codelineno-21-18">18</a></span>
<span class="normal"><a href="#__codelineno-21-19">19</a></span>
<span class="normal"><a href="#__codelineno-21-20">20</a></span>
<span class="normal"><a href="#__codelineno-21-21">21</a></span>
<span class="normal"><a href="#__codelineno-21-22">22</a></span>
<span class="normal"><a href="#__codelineno-21-23">23</a></span>
<span class="normal"><a href="#__codelineno-21-24">24</a></span>
<span class="normal"><a href="#__codelineno-21-25">25</a></span>
<span class="normal"><a href="#__codelineno-21-26">26</a></span>
<span class="normal"><a href="#__codelineno-21-27">27</a></span>
<span class="normal"><a href="#__codelineno-21-28">28</a></span>
<span class="normal"><a href="#__codelineno-21-29">29</a></span>
<span class="normal"><a href="#__codelineno-21-30">30</a></span>
<span class="normal"><a href="#__codelineno-21-31">31</a></span>
<span class="normal"><a href="#__codelineno-21-32">32</a></span>
<span class="normal"><a href="#__codelineno-21-33">33</a></span>
<span class="normal"><a href="#__codelineno-21-34">34</a></span>
<span class="normal"><a href="#__codelineno-21-35">35</a></span>
<span class="normal"><a href="#__codelineno-21-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="k">def</span> <span class="nf">send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recipient_phone_number</span><span class="p">,</span> <span class="n">message_type</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span> 
<a id="__codelineno-21-3" name="__codelineno-21-3"></a>            <span class="s2">&quot;messaging_product&quot;</span><span class="p">:</span> <span class="s2">&quot;whatsapp&quot;</span><span class="p">,</span> 
<a id="__codelineno-21-4" name="__codelineno-21-4"></a>            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">recipient_phone_number</span> 
<a id="__codelineno-21-5" name="__codelineno-21-5"></a>        <span class="p">}</span>
<a id="__codelineno-21-6" name="__codelineno-21-6"></a>
<a id="__codelineno-21-7" name="__codelineno-21-7"></a>        <span class="k">if</span> <span class="n">message_type</span><span class="o">==</span><span class="s2">&quot;text&quot;</span><span class="p">:</span>
<a id="__codelineno-21-8" name="__codelineno-21-8"></a>            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span>
<a id="__codelineno-21-9" name="__codelineno-21-9"></a>            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{</span><span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
<a id="__codelineno-21-10" name="__codelineno-21-10"></a>
<a id="__codelineno-21-11" name="__codelineno-21-11"></a>        <span class="k">if</span> <span class="n">message_type</span><span class="o">==</span><span class="s2">&quot;interactive&quot;</span><span class="p">:</span>
<a id="__codelineno-21-12" name="__codelineno-21-12"></a>            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;interactive&quot;</span>
<a id="__codelineno-21-13" name="__codelineno-21-13"></a>            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;interactive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span>
<a id="__codelineno-21-14" name="__codelineno-21-14"></a>
<a id="__codelineno-21-15" name="__codelineno-21-15"></a>        <span class="k">if</span> <span class="n">message_type</span><span class="o">==</span><span class="s2">&quot;stories&quot;</span><span class="p">:</span>
<a id="__codelineno-21-16" name="__codelineno-21-16"></a>            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;template&quot;</span>
<a id="__codelineno-21-17" name="__codelineno-21-17"></a>            <span class="n">payload</span> <span class="o">=</span>   <span class="bp">self</span><span class="o">.</span><span class="n">get_stories_template</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-21-18" name="__codelineno-21-18"></a>
<a id="__codelineno-21-19" name="__codelineno-21-19"></a>        <span class="k">if</span> <span class="n">message_type</span><span class="o">==</span><span class="s2">&quot;opinion&quot;</span><span class="p">:</span>
<a id="__codelineno-21-20" name="__codelineno-21-20"></a>            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;template&quot;</span>
<a id="__codelineno-21-21" name="__codelineno-21-21"></a>            <span class="n">payload</span> <span class="o">=</span>   <span class="bp">self</span><span class="o">.</span><span class="n">get_opinion_template</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-21-22" name="__codelineno-21-22"></a>
<a id="__codelineno-21-23" name="__codelineno-21-23"></a>
<a id="__codelineno-21-24" name="__codelineno-21-24"></a>        <span class="c1">#print(payload)</span>
<a id="__codelineno-21-25" name="__codelineno-21-25"></a>        <span class="c1">#print(f&quot;{self.API_URL}/messages&quot;,self.headers, payload)    </span>
<a id="__codelineno-21-26" name="__codelineno-21-26"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">API_URL</span><span class="si">}</span><span class="s2">/messages&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-21-27" name="__codelineno-21-27"></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-21-28" name="__codelineno-21-28"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="o">==</span><span class="mi">200</span><span class="p">):</span>
<a id="__codelineno-21-29" name="__codelineno-21-29"></a>            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
<a id="__codelineno-21-30" name="__codelineno-21-30"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_conversation_state</span><span class="p">(</span><span class="n">response</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-21-31" name="__codelineno-21-31"></a>            <span class="k">return</span> <span class="n">response</span>
<a id="__codelineno-21-32" name="__codelineno-21-32"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-21-33" name="__codelineno-21-33"></a>            <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<a id="__codelineno-21-34" name="__codelineno-21-34"></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-21-35" name="__codelineno-21-35"></a>
<a id="__codelineno-21-36" name="__codelineno-21-36"></a>        <span class="k">return</span> <span class="n">response</span>
</code></pre></div></td></tr></table></div>
<h4 id="processing-other-types-of-contents">Processing other types of contents</h4>
<p>This method returns a message to the user based on the type of content they send, such as audio, location, contact, or image.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span>
<span class="normal"><a href="#__codelineno-22-12">12</a></span>
<span class="normal"><a href="#__codelineno-22-13">13</a></span>
<span class="normal"><a href="#__codelineno-22-14">14</a></span>
<span class="normal"><a href="#__codelineno-22-15">15</a></span>
<span class="normal"><a href="#__codelineno-22-16">16</a></span>
<span class="normal"><a href="#__codelineno-22-17">17</a></span>
<span class="normal"><a href="#__codelineno-22-18">18</a></span>
<span class="normal"><a href="#__codelineno-22-19">19</a></span>
<span class="normal"><a href="#__codelineno-22-20">20</a></span>
<span class="normal"><a href="#__codelineno-22-21">21</a></span>
<span class="normal"><a href="#__codelineno-22-22">22</a></span>
<span class="normal"><a href="#__codelineno-22-23">23</a></span>
<span class="normal"><a href="#__codelineno-22-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a>    <span class="k">def</span> <span class="nf">process_diff_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">response</span><span class="p">):</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;image&quot;</span><span class="p">:</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">))</span>                      
<a id="__codelineno-22-4" name="__codelineno-22-4"></a>            <span class="k">return</span> <span class="kc">True</span> 
<a id="__codelineno-22-5" name="__codelineno-22-5"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;document&quot;</span><span class="p">:</span>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;document&quot;</span><span class="p">))</span>   
<a id="__codelineno-22-7" name="__codelineno-22-7"></a>            <span class="k">return</span> <span class="kc">True</span>         
<a id="__codelineno-22-8" name="__codelineno-22-8"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;contacts&quot;</span><span class="p">:</span>
<a id="__codelineno-22-9" name="__codelineno-22-9"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;contacts&quot;</span><span class="p">))</span>   
<a id="__codelineno-22-10" name="__codelineno-22-10"></a>            <span class="k">return</span> <span class="kc">True</span> 
<a id="__codelineno-22-11" name="__codelineno-22-11"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;location&quot;</span><span class="p">:</span>
<a id="__codelineno-22-12" name="__codelineno-22-12"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">))</span>   
<a id="__codelineno-22-13" name="__codelineno-22-13"></a>            <span class="k">return</span> <span class="kc">True</span> 
<a id="__codelineno-22-14" name="__codelineno-22-14"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;video&quot;</span><span class="p">:</span>
<a id="__codelineno-22-15" name="__codelineno-22-15"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;video&quot;</span><span class="p">))</span>  
<a id="__codelineno-22-16" name="__codelineno-22-16"></a>            <span class="k">return</span> <span class="kc">True</span> 
<a id="__codelineno-22-17" name="__codelineno-22-17"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;audio&quot;</span><span class="p">:</span>
<a id="__codelineno-22-18" name="__codelineno-22-18"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;audio&quot;</span><span class="p">))</span>  
<a id="__codelineno-22-19" name="__codelineno-22-19"></a>            <span class="k">return</span> <span class="kc">True</span> 
<a id="__codelineno-22-20" name="__codelineno-22-20"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;sticker&quot;</span><span class="p">:</span>
<a id="__codelineno-22-21" name="__codelineno-22-21"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;sticker&quot;</span><span class="p">))</span>    
<a id="__codelineno-22-22" name="__codelineno-22-22"></a>            <span class="k">return</span> <span class="kc">True</span> 
<a id="__codelineno-22-23" name="__codelineno-22-23"></a>
<a id="__codelineno-22-24" name="__codelineno-22-24"></a>        <span class="k">return</span> <span class="kc">False</span>    
</code></pre></div></td></tr></table></div>
<h4 id="main-menu">Main menu</h4>
<p>Main menu and welcome messages</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1">1</a></span>
<span class="normal"><a href="#__codelineno-23-2">2</a></span>
<span class="normal"><a href="#__codelineno-23-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a>    <span class="k">def</span> <span class="nf">main_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">response</span><span class="p">):</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;welcome&quot;</span><span class="p">))</span>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;interactive&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;main_menu&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
<h4 id="get-user-preferences">Get user preferences</h4>
<p>Get user preferences from database</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span>
<span class="normal"><a href="#__codelineno-24-12">12</a></span>
<span class="normal"><a href="#__codelineno-24-13">13</a></span>
<span class="normal"><a href="#__codelineno-24-14">14</a></span>
<span class="normal"><a href="#__codelineno-24-15">15</a></span>
<span class="normal"><a href="#__codelineno-24-16">16</a></span>
<span class="normal"><a href="#__codelineno-24-17">17</a></span>
<span class="normal"><a href="#__codelineno-24-18">18</a></span>
<span class="normal"><a href="#__codelineno-24-19">19</a></span>
<span class="normal"><a href="#__codelineno-24-20">20</a></span>
<span class="normal"><a href="#__codelineno-24-21">21</a></span>
<span class="normal"><a href="#__codelineno-24-22">22</a></span>
<span class="normal"><a href="#__codelineno-24-23">23</a></span>
<span class="normal"><a href="#__codelineno-24-24">24</a></span>
<span class="normal"><a href="#__codelineno-24-25">25</a></span>
<span class="normal"><a href="#__codelineno-24-26">26</a></span>
<span class="normal"><a href="#__codelineno-24-27">27</a></span>
<span class="normal"><a href="#__codelineno-24-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a>    <span class="k">def</span> <span class="nf">__get_user_prefs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a>        <span class="n">r</span>       <span class="o">=</span>   <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:{</span> <span class="s2">&quot;$eq&quot;</span><span class="p">:</span> <span class="n">user_id</span> <span class="p">}},</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span> <span class="p">)</span>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a>        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a>            <span class="n">user</span> <span class="o">=</span>  <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;docs&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a>            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;topics_prefs&quot;</span><span class="p">)</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-24-6" name="__codelineno-24-6"></a>                <span class="n">user</span><span class="p">[</span><span class="s2">&quot;topics_prefs&quot;</span><span class="p">]</span>    <span class="o">=</span>   <span class="p">[]</span>
<a id="__codelineno-24-7" name="__codelineno-24-7"></a>
<a id="__codelineno-24-8" name="__codelineno-24-8"></a>            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;locations_prefs&quot;</span><span class="p">)</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-24-9" name="__codelineno-24-9"></a>                <span class="n">user</span><span class="p">[</span><span class="s2">&quot;locations_prefs&quot;</span><span class="p">]</span>     <span class="o">=</span>   <span class="p">[]</span>
<a id="__codelineno-24-10" name="__codelineno-24-10"></a>
<a id="__codelineno-24-11" name="__codelineno-24-11"></a>            <span class="k">if</span>  <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unsubscribed_date&quot;</span><span class="p">)</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-24-12" name="__codelineno-24-12"></a>                <span class="n">user</span><span class="p">[</span><span class="s2">&quot;unsubscribed_date&quot;</span><span class="p">]</span>   <span class="o">=</span>   <span class="p">[]</span>
<a id="__codelineno-24-13" name="__codelineno-24-13"></a>
<a id="__codelineno-24-14" name="__codelineno-24-14"></a>            <span class="k">if</span>  <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subscription_date&quot;</span><span class="p">)</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-24-15" name="__codelineno-24-15"></a>                <span class="n">user</span><span class="p">[</span><span class="s2">&quot;subscription_date&quot;</span><span class="p">]</span><span class="o">=</span>  <span class="p">[]</span>
<a id="__codelineno-24-16" name="__codelineno-24-16"></a>            <span class="n">u</span> <span class="o">=</span>  <span class="p">{</span>
<a id="__codelineno-24-17" name="__codelineno-24-17"></a>                        <span class="s2">&quot;user_id&quot;</span>               <span class="p">:</span>   <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span>
<a id="__codelineno-24-18" name="__codelineno-24-18"></a>                        <span class="s2">&quot;name&quot;</span>                  <span class="p">:</span>   <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
<a id="__codelineno-24-19" name="__codelineno-24-19"></a>                        <span class="s2">&quot;active&quot;</span>                <span class="p">:</span>   <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">),</span>
<a id="__codelineno-24-20" name="__codelineno-24-20"></a>                        <span class="s2">&quot;all_content&quot;</span>           <span class="p">:</span>   <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;all_content&quot;</span><span class="p">),</span>
<a id="__codelineno-24-21" name="__codelineno-24-21"></a>                        <span class="s2">&quot;topics_prefs&quot;</span>          <span class="p">:</span>   <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;topics_prefs&quot;</span><span class="p">),</span>
<a id="__codelineno-24-22" name="__codelineno-24-22"></a>                        <span class="s2">&quot;locations_prefs&quot;</span>       <span class="p">:</span>   <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;locations_prefs&quot;</span><span class="p">),</span>
<a id="__codelineno-24-23" name="__codelineno-24-23"></a>                        <span class="s2">&quot;subscription_date&quot;</span>     <span class="p">:</span>   <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subscription_date&quot;</span><span class="p">),</span>
<a id="__codelineno-24-24" name="__codelineno-24-24"></a>                        <span class="s2">&quot;unsubscribed_date&quot;</span>     <span class="p">:</span>   <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unsubscribed_date&quot;</span><span class="p">),</span>
<a id="__codelineno-24-25" name="__codelineno-24-25"></a>                    <span class="p">}</span>
<a id="__codelineno-24-26" name="__codelineno-24-26"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span><span class="n">u</span><span class="p">}</span>
<a id="__codelineno-24-27" name="__codelineno-24-27"></a>
<a id="__codelineno-24-28" name="__codelineno-24-28"></a>        <span class="k">return</span>  <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="create-a-user">Create a user</h4>
<p>Create a user json object</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span>
<span class="normal"><a href="#__codelineno-25-11">11</a></span>
<span class="normal"><a href="#__codelineno-25-12">12</a></span>
<span class="normal"><a href="#__codelineno-25-13">13</a></span>
<span class="normal"><a href="#__codelineno-25-14">14</a></span>
<span class="normal"><a href="#__codelineno-25-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a>    <span class="k">def</span> <span class="nf">__create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">all_content</span><span class="p">,</span> <span class="n">topics_prefs</span><span class="p">,</span>  <span class="n">locations_prefs</span><span class="p">):</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a>        <span class="n">doc</span> <span class="o">=</span>  <span class="p">{</span>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a>                    <span class="s2">&quot;user_id&quot;</span>               <span class="p">:</span>   <span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a>                    <span class="s2">&quot;_id&quot;</span>                   <span class="p">:</span>   <span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-25-6" name="__codelineno-25-6"></a>                    <span class="s2">&quot;name&quot;</span>                  <span class="p">:</span>   <span class="n">name</span><span class="p">,</span>
<a id="__codelineno-25-7" name="__codelineno-25-7"></a>                    <span class="s2">&quot;active&quot;</span>                <span class="p">:</span>   <span class="n">active</span><span class="p">,</span>
<a id="__codelineno-25-8" name="__codelineno-25-8"></a>                    <span class="s2">&quot;all_content&quot;</span>           <span class="p">:</span>   <span class="n">all_content</span><span class="p">,</span>
<a id="__codelineno-25-9" name="__codelineno-25-9"></a>                    <span class="s2">&quot;topics_prefs&quot;</span>          <span class="p">:</span>   <span class="n">topics_prefs</span><span class="p">,</span>
<a id="__codelineno-25-10" name="__codelineno-25-10"></a>                    <span class="s2">&quot;locations_prefs&quot;</span>       <span class="p">:</span>   <span class="n">locations_prefs</span><span class="p">,</span>
<a id="__codelineno-25-11" name="__codelineno-25-11"></a>                    <span class="s2">&quot;subscription_date&quot;</span>     <span class="p">:</span>   <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;America/Sao_Paulo&#39;</span><span class="p">))],</span>
<a id="__codelineno-25-12" name="__codelineno-25-12"></a>                    <span class="s2">&quot;unsubscribed_date&quot;</span>     <span class="p">:</span>   <span class="p">[],</span>
<a id="__codelineno-25-13" name="__codelineno-25-13"></a>                    <span class="s2">&quot;verified&quot;</span>              <span class="p">:</span>   <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-25-14" name="__codelineno-25-14"></a>                <span class="p">}</span>
<a id="__codelineno-25-15" name="__codelineno-25-15"></a>        <span class="k">return</span> <span class="n">doc</span>
</code></pre></div></td></tr></table></div>
<h4 id="choose-all-content">Choose all content</h4>
<p>Set user preference and send a message</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-26-10">10</a></span>
<span class="normal"><a href="#__codelineno-26-11">11</a></span>
<span class="normal"><a href="#__codelineno-26-12">12</a></span>
<span class="normal"><a href="#__codelineno-26-13">13</a></span>
<span class="normal"><a href="#__codelineno-26-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a>    <span class="k">def</span> <span class="nf">__choose_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a>        <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]:</span>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a>            <span class="n">user</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;new&quot;</span><span class="p">)</span>
<a id="__codelineno-26-5" name="__codelineno-26-5"></a>            <span class="n">user</span><span class="p">[</span><span class="s2">&quot;all_content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-26-6" name="__codelineno-26-6"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,[</span><span class="n">user</span><span class="p">])</span>
<a id="__codelineno-26-7" name="__codelineno-26-7"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;ALL_CONTENT&quot;</span><span class="p">))</span>
<a id="__codelineno-26-8" name="__codelineno-26-8"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-26-9" name="__codelineno-26-9"></a>
<a id="__codelineno-26-10" name="__codelineno-26-10"></a>        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;all_content&quot;</span><span class="p">):</span>
<a id="__codelineno-26-11" name="__codelineno-26-11"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;Você já estava cadastrado para receber todo nosso conteúdo 😃&quot;</span><span class="p">)</span>
<a id="__codelineno-26-12" name="__codelineno-26-12"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-26-13" name="__codelineno-26-13"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:{</span><span class="s2">&quot;$eq&quot;</span><span class="p">:</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)}},</span> <span class="p">{</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;all_content&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;topics_prefs&quot;</span><span class="p">:[],</span>  <span class="s2">&quot;locations_prefs&quot;</span><span class="p">:[]</span>  <span class="p">}</span> <span class="p">})</span>             
<a id="__codelineno-26-14" name="__codelineno-26-14"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;ALL_CONTENT&quot;</span><span class="p">))</span>    
</code></pre></div></td></tr></table></div>
<h4 id="create-a-single-button">Create a single button</h4>
<p>Create a button based on input parameters</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span>
<span class="normal"><a href="#__codelineno-27-18">18</a></span>
<span class="normal"><a href="#__codelineno-27-19">19</a></span>
<span class="normal"><a href="#__codelineno-27-20">20</a></span>
<span class="normal"><a href="#__codelineno-27-21">21</a></span>
<span class="normal"><a href="#__codelineno-27-22">22</a></span>
<span class="normal"><a href="#__codelineno-27-23">23</a></span>
<span class="normal"><a href="#__codelineno-27-24">24</a></span>
<span class="normal"><a href="#__codelineno-27-25">25</a></span>
<span class="normal"><a href="#__codelineno-27-26">26</a></span>
<span class="normal"><a href="#__codelineno-27-27">27</a></span>
<span class="normal"><a href="#__codelineno-27-28">28</a></span>
<span class="normal"><a href="#__codelineno-27-29">29</a></span>
<span class="normal"><a href="#__codelineno-27-30">30</a></span>
<span class="normal"><a href="#__codelineno-27-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a>    <span class="k">def</span> <span class="nf">create_button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">button_message</span><span class="p">,</span> <span class="n">response_1</span><span class="p">,</span> <span class="n">response_1_id</span><span class="p">,</span> <span class="n">response_2</span><span class="p">,</span> <span class="n">response_2_id</span> <span class="p">):</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a>        <span class="n">button</span>  <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a>        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;button&quot;</span><span class="p">,</span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a>        <span class="s2">&quot;header&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a>          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-27-6" name="__codelineno-27-6"></a>          <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">button_message</span>
<a id="__codelineno-27-7" name="__codelineno-27-7"></a>        <span class="p">},</span>
<a id="__codelineno-27-8" name="__codelineno-27-8"></a>        <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-27-9" name="__codelineno-27-9"></a>          <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;  ‎   &quot;</span>
<a id="__codelineno-27-10" name="__codelineno-27-10"></a>        <span class="p">},</span>
<a id="__codelineno-27-11" name="__codelineno-27-11"></a>        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-27-12" name="__codelineno-27-12"></a>          <span class="s2">&quot;buttons&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-27-13" name="__codelineno-27-13"></a>            <span class="p">{</span>
<a id="__codelineno-27-14" name="__codelineno-27-14"></a>              <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;reply&quot;</span><span class="p">,</span>
<a id="__codelineno-27-15" name="__codelineno-27-15"></a>              <span class="s2">&quot;reply&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-27-16" name="__codelineno-27-16"></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">response_1_id</span><span class="p">,</span>
<a id="__codelineno-27-17" name="__codelineno-27-17"></a>                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">response_1</span> 
<a id="__codelineno-27-18" name="__codelineno-27-18"></a>              <span class="p">}</span>
<a id="__codelineno-27-19" name="__codelineno-27-19"></a>            <span class="p">},</span>
<a id="__codelineno-27-20" name="__codelineno-27-20"></a>            <span class="p">{</span>
<a id="__codelineno-27-21" name="__codelineno-27-21"></a>              <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;reply&quot;</span><span class="p">,</span>
<a id="__codelineno-27-22" name="__codelineno-27-22"></a>              <span class="s2">&quot;reply&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-27-23" name="__codelineno-27-23"></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">response_2_id</span><span class="p">,</span>
<a id="__codelineno-27-24" name="__codelineno-27-24"></a>                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">response_2</span>
<a id="__codelineno-27-25" name="__codelineno-27-25"></a>              <span class="p">}</span>
<a id="__codelineno-27-26" name="__codelineno-27-26"></a>            <span class="p">}</span>
<a id="__codelineno-27-27" name="__codelineno-27-27"></a>          <span class="p">]</span> 
<a id="__codelineno-27-28" name="__codelineno-27-28"></a>        <span class="p">}</span>   
<a id="__codelineno-27-29" name="__codelineno-27-29"></a>        <span class="p">}</span>
<a id="__codelineno-27-30" name="__codelineno-27-30"></a>
<a id="__codelineno-27-31" name="__codelineno-27-31"></a>        <span class="k">return</span> <span class="n">button</span>   
</code></pre></div></td></tr></table></div>
<h4 id="saving-user-prefrences">Saving user prefrences</h4>
<p>This method salve user's preferences on database</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span>
<span class="normal"><a href="#__codelineno-28-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a>    <span class="k">def</span> <span class="nf">__save_user_prefs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<a id="__codelineno-28-2" name="__codelineno-28-2"></a>        <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]:</span>
<a id="__codelineno-28-3" name="__codelineno-28-3"></a>            <span class="n">user</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;new&quot;</span><span class="p">)</span>
<a id="__codelineno-28-4" name="__codelineno-28-4"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,[</span><span class="n">user</span><span class="p">])</span> 
<a id="__codelineno-28-5" name="__codelineno-28-5"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-28-6" name="__codelineno-28-6"></a>            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">):</span>
<a id="__codelineno-28-7" name="__codelineno-28-7"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:{</span><span class="s2">&quot;$eq&quot;</span><span class="p">:</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)}},</span> <span class="p">{</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;topics_prefs&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;topics_prefs&quot;</span><span class="p">),</span> <span class="s2">&quot;locations_prefs&quot;</span><span class="p">:</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;locations_prefs&quot;</span><span class="p">)</span> <span class="p">}</span> <span class="p">})</span>             
<a id="__codelineno-28-8" name="__codelineno-28-8"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-28-9" name="__codelineno-28-9"></a>                <span class="n">sub_date</span>    <span class="o">=</span>   <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;America/Sao_Paulo&#39;</span><span class="p">))</span>
<a id="__codelineno-28-10" name="__codelineno-28-10"></a>                <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subscription_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_date</span><span class="p">)</span>
<a id="__codelineno-28-11" name="__codelineno-28-11"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:{</span><span class="s2">&quot;$eq&quot;</span><span class="p">:</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)}},</span> <span class="p">{</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="s2">&quot;topics_prefs&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;topics_prefs&quot;</span><span class="p">),</span> <span class="s2">&quot;locations_prefs&quot;</span><span class="p">:</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;locations_prefs&quot;</span><span class="p">),</span><span class="s2">&quot;subscription_date&quot;</span><span class="p">:</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subscription_date&quot;</span><span class="p">)</span> <span class="p">}</span> <span class="p">})</span>
</code></pre></div></td></tr></table></div>
<h4 id="topics-menu">Topics menu</h4>
<p>This method create a WhatsApp menu for the topics
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-29-10">10</a></span>
<span class="normal"><a href="#__codelineno-29-11">11</a></span>
<span class="normal"><a href="#__codelineno-29-12">12</a></span>
<span class="normal"><a href="#__codelineno-29-13">13</a></span>
<span class="normal"><a href="#__codelineno-29-14">14</a></span>
<span class="normal"><a href="#__codelineno-29-15">15</a></span>
<span class="normal"><a href="#__codelineno-29-16">16</a></span>
<span class="normal"><a href="#__codelineno-29-17">17</a></span>
<span class="normal"><a href="#__codelineno-29-18">18</a></span>
<span class="normal"><a href="#__codelineno-29-19">19</a></span>
<span class="normal"><a href="#__codelineno-29-20">20</a></span>
<span class="normal"><a href="#__codelineno-29-21">21</a></span>
<span class="normal"><a href="#__codelineno-29-22">22</a></span>
<span class="normal"><a href="#__codelineno-29-23">23</a></span>
<span class="normal"><a href="#__codelineno-29-24">24</a></span>
<span class="normal"><a href="#__codelineno-29-25">25</a></span>
<span class="normal"><a href="#__codelineno-29-26">26</a></span>
<span class="normal"><a href="#__codelineno-29-27">27</a></span>
<span class="normal"><a href="#__codelineno-29-28">28</a></span>
<span class="normal"><a href="#__codelineno-29-29">29</a></span>
<span class="normal"><a href="#__codelineno-29-30">30</a></span>
<span class="normal"><a href="#__codelineno-29-31">31</a></span>
<span class="normal"><a href="#__codelineno-29-32">32</a></span>
<span class="normal"><a href="#__codelineno-29-33">33</a></span>
<span class="normal"><a href="#__codelineno-29-34">34</a></span>
<span class="normal"><a href="#__codelineno-29-35">35</a></span>
<span class="normal"><a href="#__codelineno-29-36">36</a></span>
<span class="normal"><a href="#__codelineno-29-37">37</a></span>
<span class="normal"><a href="#__codelineno-29-38">38</a></span>
<span class="normal"><a href="#__codelineno-29-39">39</a></span>
<span class="normal"><a href="#__codelineno-29-40">40</a></span>
<span class="normal"><a href="#__codelineno-29-41">41</a></span>
<span class="normal"><a href="#__codelineno-29-42">42</a></span>
<span class="normal"><a href="#__codelineno-29-43">43</a></span>
<span class="normal"><a href="#__codelineno-29-44">44</a></span>
<span class="normal"><a href="#__codelineno-29-45">45</a></span>
<span class="normal"><a href="#__codelineno-29-46">46</a></span>
<span class="normal"><a href="#__codelineno-29-47">47</a></span>
<span class="normal"><a href="#__codelineno-29-48">48</a></span>
<span class="normal"><a href="#__codelineno-29-49">49</a></span>
<span class="normal"><a href="#__codelineno-29-50">50</a></span>
<span class="normal"><a href="#__codelineno-29-51">51</a></span>
<span class="normal"><a href="#__codelineno-29-52">52</a></span>
<span class="normal"><a href="#__codelineno-29-53">53</a></span>
<span class="normal"><a href="#__codelineno-29-54">54</a></span>
<span class="normal"><a href="#__codelineno-29-55">55</a></span>
<span class="normal"><a href="#__codelineno-29-56">56</a></span>
<span class="normal"><a href="#__codelineno-29-57">57</a></span>
<span class="normal"><a href="#__codelineno-29-58">58</a></span>
<span class="normal"><a href="#__codelineno-29-59">59</a></span>
<span class="normal"><a href="#__codelineno-29-60">60</a></span>
<span class="normal"><a href="#__codelineno-29-61">61</a></span>
<span class="normal"><a href="#__codelineno-29-62">62</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a>    <span class="k">def</span> <span class="nf">create_topic_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_topics</span><span class="p">):</span>
<a id="__codelineno-29-2" name="__codelineno-29-2"></a>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a>        <span class="n">danos_ambientais</span>    <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;danos_ambientais&quot;</span>  <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Danos ambientais&quot;</span>    <span class="p">,</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span>    
<a id="__codelineno-29-4" name="__codelineno-29-4"></a>        <span class="n">areas_protegidas</span>    <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;areas_protegidas&quot;</span>  <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Áreas Protegidas&quot;</span>    <span class="p">,</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span>
<a id="__codelineno-29-5" name="__codelineno-29-5"></a>        <span class="n">povos</span>               <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;povos&quot;</span>             <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Povos&quot;</span>               <span class="p">,</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span>
<a id="__codelineno-29-6" name="__codelineno-29-6"></a>        <span class="n">mudanca_climatica</span>   <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;mudanca_climatica&quot;</span> <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Mudança climática&quot;</span>   <span class="p">,</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span>
<a id="__codelineno-29-7" name="__codelineno-29-7"></a>        <span class="n">conservacao</span>         <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;conservacao&quot;</span>       <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Conservação&quot;</span>         <span class="p">,</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span>
<a id="__codelineno-29-8" name="__codelineno-29-8"></a>        <span class="n">politica_economia</span>   <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;politica_economia&quot;</span> <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Política e economia&quot;</span> <span class="p">,</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span>                            
<a id="__codelineno-29-9" name="__codelineno-29-9"></a>        <span class="n">all_topics</span>          <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;all_topics&quot;</span>        <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Todos os temas&quot;</span>      <span class="p">,</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span> 
<a id="__codelineno-29-10" name="__codelineno-29-10"></a>        <span class="n">topic_options</span>       <span class="o">=</span>   <span class="p">[]</span>
<a id="__codelineno-29-11" name="__codelineno-29-11"></a>
<a id="__codelineno-29-12" name="__codelineno-29-12"></a>        <span class="k">if</span>  <span class="nb">len</span><span class="p">(</span><span class="n">user_topics</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">:</span>
<a id="__codelineno-29-13" name="__codelineno-29-13"></a>            <span class="n">topic_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_topics</span><span class="p">)</span>
<a id="__codelineno-29-14" name="__codelineno-29-14"></a>
<a id="__codelineno-29-15" name="__codelineno-29-15"></a>        <span class="k">if</span> <span class="s2">&quot;danos_ambientais&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_topics</span><span class="p">:</span>
<a id="__codelineno-29-16" name="__codelineno-29-16"></a>            <span class="n">topic_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">danos_ambientais</span><span class="p">)</span>
<a id="__codelineno-29-17" name="__codelineno-29-17"></a>
<a id="__codelineno-29-18" name="__codelineno-29-18"></a>        <span class="k">if</span> <span class="s2">&quot;areas_protegidas&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_topics</span><span class="p">:</span>
<a id="__codelineno-29-19" name="__codelineno-29-19"></a>            <span class="n">topic_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">areas_protegidas</span><span class="p">)</span>
<a id="__codelineno-29-20" name="__codelineno-29-20"></a>
<a id="__codelineno-29-21" name="__codelineno-29-21"></a>        <span class="k">if</span> <span class="s2">&quot;povos&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_topics</span><span class="p">:</span>
<a id="__codelineno-29-22" name="__codelineno-29-22"></a>            <span class="n">topic_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">povos</span><span class="p">)</span>
<a id="__codelineno-29-23" name="__codelineno-29-23"></a>
<a id="__codelineno-29-24" name="__codelineno-29-24"></a>        <span class="k">if</span> <span class="s2">&quot;mudanca_climatica&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_topics</span><span class="p">:</span>
<a id="__codelineno-29-25" name="__codelineno-29-25"></a>            <span class="n">topic_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mudanca_climatica</span><span class="p">)</span>
<a id="__codelineno-29-26" name="__codelineno-29-26"></a>
<a id="__codelineno-29-27" name="__codelineno-29-27"></a>        <span class="k">if</span> <span class="s2">&quot;conservacao&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_topics</span><span class="p">:</span>
<a id="__codelineno-29-28" name="__codelineno-29-28"></a>            <span class="n">topic_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conservacao</span><span class="p">)</span>           
<a id="__codelineno-29-29" name="__codelineno-29-29"></a>
<a id="__codelineno-29-30" name="__codelineno-29-30"></a>        <span class="k">if</span> <span class="s2">&quot;politica_economia&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_topics</span><span class="p">:</span>
<a id="__codelineno-29-31" name="__codelineno-29-31"></a>            <span class="n">topic_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">politica_economia</span><span class="p">)</span>
<a id="__codelineno-29-32" name="__codelineno-29-32"></a>
<a id="__codelineno-29-33" name="__codelineno-29-33"></a>
<a id="__codelineno-29-34" name="__codelineno-29-34"></a>
<a id="__codelineno-29-35" name="__codelineno-29-35"></a>
<a id="__codelineno-29-36" name="__codelineno-29-36"></a>        <span class="n">topics</span> <span class="o">=</span>    <span class="p">{</span>
<a id="__codelineno-29-37" name="__codelineno-29-37"></a>
<a id="__codelineno-29-38" name="__codelineno-29-38"></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span>
<a id="__codelineno-29-39" name="__codelineno-29-39"></a>                    <span class="s2">&quot;header&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-29-40" name="__codelineno-29-40"></a>                      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-29-41" name="__codelineno-29-41"></a>                      <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Escolha os temas:&quot;</span>
<a id="__codelineno-29-42" name="__codelineno-29-42"></a>                    <span class="p">},</span>
<a id="__codelineno-29-43" name="__codelineno-29-43"></a>                    <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-29-44" name="__codelineno-29-44"></a>                      <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;📝 Selecione uma das opções.&quot;</span>
<a id="__codelineno-29-45" name="__codelineno-29-45"></a>                    <span class="p">},</span>
<a id="__codelineno-29-46" name="__codelineno-29-46"></a>                    <span class="s2">&quot;footer&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-29-47" name="__codelineno-29-47"></a>                      <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;‎ &quot;</span>
<a id="__codelineno-29-48" name="__codelineno-29-48"></a>                    <span class="p">},</span>
<a id="__codelineno-29-49" name="__codelineno-29-49"></a>                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-29-50" name="__codelineno-29-50"></a>                      <span class="s2">&quot;button&quot;</span><span class="p">:</span> <span class="s2">&quot;Clique aqui&quot;</span><span class="p">,</span>
<a id="__codelineno-29-51" name="__codelineno-29-51"></a>                      <span class="s2">&quot;sections&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-29-52" name="__codelineno-29-52"></a>                        <span class="p">{</span>
<a id="__codelineno-29-53" name="__codelineno-29-53"></a>                          <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;personalize o conteúdo&quot;</span><span class="p">,</span>
<a id="__codelineno-29-54" name="__codelineno-29-54"></a>                          <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="n">topic_options</span>
<a id="__codelineno-29-55" name="__codelineno-29-55"></a>                        <span class="p">}</span>
<a id="__codelineno-29-56" name="__codelineno-29-56"></a>
<a id="__codelineno-29-57" name="__codelineno-29-57"></a>                      <span class="p">]</span>
<a id="__codelineno-29-58" name="__codelineno-29-58"></a>                    <span class="p">}</span>
<a id="__codelineno-29-59" name="__codelineno-29-59"></a>                  <span class="p">}</span>
<a id="__codelineno-29-60" name="__codelineno-29-60"></a>
<a id="__codelineno-29-61" name="__codelineno-29-61"></a>
<a id="__codelineno-29-62" name="__codelineno-29-62"></a>        <span class="k">return</span> <span class="n">topics</span>
</code></pre></div></td></tr></table></div></p>
<h4 id="topics-options">Topics options</h4>
<p>This method show to user the topcis options</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-30-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-30-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-30-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-30-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-30-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-30-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-30-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-30-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-30-10">10</a></span>
<span class="normal"><a href="#__codelineno-30-11">11</a></span>
<span class="normal"><a href="#__codelineno-30-12">12</a></span>
<span class="normal"><a href="#__codelineno-30-13">13</a></span>
<span class="normal"><a href="#__codelineno-30-14">14</a></span>
<span class="normal"><a href="#__codelineno-30-15">15</a></span>
<span class="normal"><a href="#__codelineno-30-16">16</a></span>
<span class="normal"><a href="#__codelineno-30-17">17</a></span>
<span class="normal"><a href="#__codelineno-30-18">18</a></span>
<span class="normal"><a href="#__codelineno-30-19">19</a></span>
<span class="normal"><a href="#__codelineno-30-20">20</a></span>
<span class="normal"><a href="#__codelineno-30-21">21</a></span>
<span class="normal"><a href="#__codelineno-30-22">22</a></span>
<span class="normal"><a href="#__codelineno-30-23">23</a></span>
<span class="normal"><a href="#__codelineno-30-24">24</a></span>
<span class="normal"><a href="#__codelineno-30-25">25</a></span>
<span class="normal"><a href="#__codelineno-30-26">26</a></span>
<span class="normal"><a href="#__codelineno-30-27">27</a></span>
<span class="normal"><a href="#__codelineno-30-28">28</a></span>
<span class="normal"><a href="#__codelineno-30-29">29</a></span>
<span class="normal"><a href="#__codelineno-30-30">30</a></span>
<span class="normal"><a href="#__codelineno-30-31">31</a></span>
<span class="normal"><a href="#__codelineno-30-32">32</a></span>
<span class="normal"><a href="#__codelineno-30-33">33</a></span>
<span class="normal"><a href="#__codelineno-30-34">34</a></span>
<span class="normal"><a href="#__codelineno-30-35">35</a></span>
<span class="normal"><a href="#__codelineno-30-36">36</a></span>
<span class="normal"><a href="#__codelineno-30-37">37</a></span>
<span class="normal"><a href="#__codelineno-30-38">38</a></span>
<span class="normal"><a href="#__codelineno-30-39">39</a></span>
<span class="normal"><a href="#__codelineno-30-40">40</a></span>
<span class="normal"><a href="#__codelineno-30-41">41</a></span>
<span class="normal"><a href="#__codelineno-30-42">42</a></span>
<span class="normal"><a href="#__codelineno-30-43">43</a></span>
<span class="normal"><a href="#__codelineno-30-44">44</a></span>
<span class="normal"><a href="#__codelineno-30-45">45</a></span>
<span class="normal"><a href="#__codelineno-30-46">46</a></span>
<span class="normal"><a href="#__codelineno-30-47">47</a></span>
<span class="normal"><a href="#__codelineno-30-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a>    <span class="k">def</span> <span class="nf">__choose_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span><span class="n">msg_id</span><span class="p">):</span>
<a id="__codelineno-30-2" name="__codelineno-30-2"></a>        <span class="n">choose_topics</span>   <span class="o">=</span>   <span class="s2">&quot;👍Legal! Agora você poderá escolher quais temas te interessam 📝. Selecione o primeiro tema. Você poderá escolher outros em seguida.&quot;</span>
<a id="__codelineno-30-3" name="__codelineno-30-3"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]:</span>
<a id="__codelineno-30-4" name="__codelineno-30-4"></a>            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;all_content&quot;</span><span class="p">):</span>
<a id="__codelineno-30-5" name="__codelineno-30-5"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;Você já estava cadastrado para receber todo nosso conteúdo 😃&quot;</span><span class="p">)</span>
<a id="__codelineno-30-6" name="__codelineno-30-6"></a>                <span class="k">return</span> <span class="kc">True</span>     
<a id="__codelineno-30-7" name="__codelineno-30-7"></a>
<a id="__codelineno-30-8" name="__codelineno-30-8"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;topics_prefs&quot;</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-30-9" name="__codelineno-30-9"></a>            <span class="n">menu</span>    <span class="o">=</span>   <span class="bp">self</span><span class="o">.</span><span class="n">create_topic_menu</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;topics_prefs&quot;</span><span class="p">))</span>
<a id="__codelineno-30-10" name="__codelineno-30-10"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-30-11" name="__codelineno-30-11"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;Você já se cadastrou em todos os temas 😃&quot;</span><span class="p">)</span>
<a id="__codelineno-30-12" name="__codelineno-30-12"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-30-13" name="__codelineno-30-13"></a>
<a id="__codelineno-30-14" name="__codelineno-30-14"></a>        <span class="k">if</span> <span class="n">msg_id</span> <span class="o">==</span><span class="s2">&quot;MAIN_TOPCIS&quot;</span><span class="p">:</span>
<a id="__codelineno-30-15" name="__codelineno-30-15"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">choose_topics</span><span class="p">)</span>
<a id="__codelineno-30-16" name="__codelineno-30-16"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;interactive&quot;</span><span class="p">,</span> <span class="n">menu</span><span class="p">)</span> 
<a id="__codelineno-30-17" name="__codelineno-30-17"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-30-18" name="__codelineno-30-18"></a>
<a id="__codelineno-30-19" name="__codelineno-30-19"></a>        <span class="k">if</span>  <span class="n">msg_id</span><span class="o">==</span><span class="s2">&quot;TOPIC_BTN_YES&quot;</span><span class="p">:</span>
<a id="__codelineno-30-20" name="__codelineno-30-20"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;topics_prefs&quot;</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-30-21" name="__codelineno-30-21"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;Escolha agora outro tema de conteúdos sobre a Amazônia 🌳&quot;</span><span class="p">)</span>
<a id="__codelineno-30-22" name="__codelineno-30-22"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;interactive&quot;</span><span class="p">,</span> <span class="n">menu</span><span class="p">)</span> 
<a id="__codelineno-30-23" name="__codelineno-30-23"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-30-24" name="__codelineno-30-24"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;ALL_CONTENT&quot;</span><span class="p">))</span>
<a id="__codelineno-30-25" name="__codelineno-30-25"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-30-26" name="__codelineno-30-26"></a>
<a id="__codelineno-30-27" name="__codelineno-30-27"></a>
<a id="__codelineno-30-28" name="__codelineno-30-28"></a>        <span class="k">if</span> <span class="n">msg_id</span> <span class="o">==</span><span class="s2">&quot;all_topics&quot;</span><span class="p">:</span>
<a id="__codelineno-30-29" name="__codelineno-30-29"></a>            <span class="n">user</span><span class="p">[</span><span class="s2">&quot;topics_prefs&quot;</span><span class="p">]</span>    <span class="o">=</span>   <span class="p">[</span><span class="s2">&quot;danos_ambientais&quot;</span><span class="p">,</span><span class="s2">&quot;areas_protegidas&quot;</span><span class="p">,</span><span class="s2">&quot;povos&quot;</span><span class="p">,</span><span class="s2">&quot;mudanca_climatica&quot;</span><span class="p">,</span><span class="s2">&quot;conservacao&quot;</span><span class="p">,</span><span class="s2">&quot;politica_economia&quot;</span><span class="p">]</span>       
<a id="__codelineno-30-30" name="__codelineno-30-30"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__save_user_prefs</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-30-31" name="__codelineno-30-31"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;ALL_CONTENT&quot;</span><span class="p">))</span>
<a id="__codelineno-30-32" name="__codelineno-30-32"></a>
<a id="__codelineno-30-33" name="__codelineno-30-33"></a>
<a id="__codelineno-30-34" name="__codelineno-30-34"></a>        <span class="k">if</span> <span class="n">msg_id</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;danos_ambientais&quot;</span><span class="p">,</span><span class="s2">&quot;areas_protegidas&quot;</span><span class="p">,</span><span class="s2">&quot;povos&quot;</span><span class="p">,</span><span class="s2">&quot;mudanca_climatica&quot;</span><span class="p">,</span><span class="s2">&quot;conservacao&quot;</span><span class="p">,</span><span class="s2">&quot;politica_economia&quot;</span><span class="p">,</span> <span class="s2">&quot;TOPIC_BTN_YES&quot;</span><span class="p">,</span><span class="s2">&quot;TOPIC_BTN_NO&quot;</span><span class="p">]:</span>
<a id="__codelineno-30-35" name="__codelineno-30-35"></a>            <span class="k">if</span>  <span class="n">msg_id</span> <span class="ow">not</span>  <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TOPIC_BTN_YES&quot;</span><span class="p">,</span><span class="s2">&quot;TOPIC_BTN_NO&quot;</span><span class="p">]:</span>
<a id="__codelineno-30-36" name="__codelineno-30-36"></a>                <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;topics_prefs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg_id</span><span class="p">)</span> 
<a id="__codelineno-30-37" name="__codelineno-30-37"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__save_user_prefs</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-30-38" name="__codelineno-30-38"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;topics_prefs&quot;</span><span class="p">))</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-30-39" name="__codelineno-30-39"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;ALL_CONTENT&quot;</span><span class="p">))</span>
<a id="__codelineno-30-40" name="__codelineno-30-40"></a>
<a id="__codelineno-30-41" name="__codelineno-30-41"></a>
<a id="__codelineno-30-42" name="__codelineno-30-42"></a>            <span class="k">if</span>  <span class="n">msg_id</span><span class="o">!=</span> <span class="s2">&quot;TOPIC_BTN_NO&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;topics_prefs&quot;</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">:</span>    
<a id="__codelineno-30-43" name="__codelineno-30-43"></a>                <span class="n">button</span>  <span class="o">=</span>   <span class="bp">self</span><span class="o">.</span><span class="n">create_button</span><span class="p">(</span><span class="s2">&quot;📝Deseja receber conteúdos de outros temas?&quot;</span><span class="p">,</span> <span class="s2">&quot;Sim&quot;</span><span class="p">,</span> <span class="s2">&quot;TOPIC_BTN_YES&quot;</span><span class="p">,</span> <span class="s2">&quot;Não&quot;</span><span class="p">,</span> <span class="s2">&quot;TOPIC_BTN_NO&quot;</span> <span class="p">)</span>
<a id="__codelineno-30-44" name="__codelineno-30-44"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;interactive&quot;</span><span class="p">,</span> <span class="n">button</span><span class="p">)</span>
<a id="__codelineno-30-45" name="__codelineno-30-45"></a>                <span class="k">return</span> <span class="kc">True</span> 
<a id="__codelineno-30-46" name="__codelineno-30-46"></a>            <span class="k">if</span>  <span class="n">msg_id</span><span class="o">==</span> <span class="s2">&quot;TOPIC_BTN_NO&quot;</span><span class="p">:</span>        
<a id="__codelineno-30-47" name="__codelineno-30-47"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;ALL_CONTENT&quot;</span><span class="p">))</span>            
<a id="__codelineno-30-48" name="__codelineno-30-48"></a>                <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
<h4 id="location-menu">Location menu</h4>
<p>This method create a WhatsApp menu for the locations
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span>
<span class="normal"><a href="#__codelineno-31-11">11</a></span>
<span class="normal"><a href="#__codelineno-31-12">12</a></span>
<span class="normal"><a href="#__codelineno-31-13">13</a></span>
<span class="normal"><a href="#__codelineno-31-14">14</a></span>
<span class="normal"><a href="#__codelineno-31-15">15</a></span>
<span class="normal"><a href="#__codelineno-31-16">16</a></span>
<span class="normal"><a href="#__codelineno-31-17">17</a></span>
<span class="normal"><a href="#__codelineno-31-18">18</a></span>
<span class="normal"><a href="#__codelineno-31-19">19</a></span>
<span class="normal"><a href="#__codelineno-31-20">20</a></span>
<span class="normal"><a href="#__codelineno-31-21">21</a></span>
<span class="normal"><a href="#__codelineno-31-22">22</a></span>
<span class="normal"><a href="#__codelineno-31-23">23</a></span>
<span class="normal"><a href="#__codelineno-31-24">24</a></span>
<span class="normal"><a href="#__codelineno-31-25">25</a></span>
<span class="normal"><a href="#__codelineno-31-26">26</a></span>
<span class="normal"><a href="#__codelineno-31-27">27</a></span>
<span class="normal"><a href="#__codelineno-31-28">28</a></span>
<span class="normal"><a href="#__codelineno-31-29">29</a></span>
<span class="normal"><a href="#__codelineno-31-30">30</a></span>
<span class="normal"><a href="#__codelineno-31-31">31</a></span>
<span class="normal"><a href="#__codelineno-31-32">32</a></span>
<span class="normal"><a href="#__codelineno-31-33">33</a></span>
<span class="normal"><a href="#__codelineno-31-34">34</a></span>
<span class="normal"><a href="#__codelineno-31-35">35</a></span>
<span class="normal"><a href="#__codelineno-31-36">36</a></span>
<span class="normal"><a href="#__codelineno-31-37">37</a></span>
<span class="normal"><a href="#__codelineno-31-38">38</a></span>
<span class="normal"><a href="#__codelineno-31-39">39</a></span>
<span class="normal"><a href="#__codelineno-31-40">40</a></span>
<span class="normal"><a href="#__codelineno-31-41">41</a></span>
<span class="normal"><a href="#__codelineno-31-42">42</a></span>
<span class="normal"><a href="#__codelineno-31-43">43</a></span>
<span class="normal"><a href="#__codelineno-31-44">44</a></span>
<span class="normal"><a href="#__codelineno-31-45">45</a></span>
<span class="normal"><a href="#__codelineno-31-46">46</a></span>
<span class="normal"><a href="#__codelineno-31-47">47</a></span>
<span class="normal"><a href="#__codelineno-31-48">48</a></span>
<span class="normal"><a href="#__codelineno-31-49">49</a></span>
<span class="normal"><a href="#__codelineno-31-50">50</a></span>
<span class="normal"><a href="#__codelineno-31-51">51</a></span>
<span class="normal"><a href="#__codelineno-31-52">52</a></span>
<span class="normal"><a href="#__codelineno-31-53">53</a></span>
<span class="normal"><a href="#__codelineno-31-54">54</a></span>
<span class="normal"><a href="#__codelineno-31-55">55</a></span>
<span class="normal"><a href="#__codelineno-31-56">56</a></span>
<span class="normal"><a href="#__codelineno-31-57">57</a></span>
<span class="normal"><a href="#__codelineno-31-58">58</a></span>
<span class="normal"><a href="#__codelineno-31-59">59</a></span>
<span class="normal"><a href="#__codelineno-31-60">60</a></span>
<span class="normal"><a href="#__codelineno-31-61">61</a></span>
<span class="normal"><a href="#__codelineno-31-62">62</a></span>
<span class="normal"><a href="#__codelineno-31-63">63</a></span>
<span class="normal"><a href="#__codelineno-31-64">64</a></span>
<span class="normal"><a href="#__codelineno-31-65">65</a></span>
<span class="normal"><a href="#__codelineno-31-66">66</a></span>
<span class="normal"><a href="#__codelineno-31-67">67</a></span>
<span class="normal"><a href="#__codelineno-31-68">68</a></span>
<span class="normal"><a href="#__codelineno-31-69">69</a></span>
<span class="normal"><a href="#__codelineno-31-70">70</a></span>
<span class="normal"><a href="#__codelineno-31-71">71</a></span>
<span class="normal"><a href="#__codelineno-31-72">72</a></span>
<span class="normal"><a href="#__codelineno-31-73">73</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="k">def</span> <span class="nf">__create_location_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_locations</span><span class="p">):</span>
<a id="__codelineno-31-2" name="__codelineno-31-2"></a>
<a id="__codelineno-31-3" name="__codelineno-31-3"></a>        <span class="n">acre</span>            <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;acre&quot;</span>          <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Acre&quot;</span>                    <span class="p">,</span>   <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span> 
<a id="__codelineno-31-4" name="__codelineno-31-4"></a>        <span class="n">amapa</span>           <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;amapa&quot;</span>         <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Amapá&quot;</span>                   <span class="p">,</span>   <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span>
<a id="__codelineno-31-5" name="__codelineno-31-5"></a>        <span class="n">amazonas</span>        <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;amazonas&quot;</span>      <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Amazonas&quot;</span>                <span class="p">,</span>   <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span>
<a id="__codelineno-31-6" name="__codelineno-31-6"></a>        <span class="n">maranhao</span>        <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;maranhao&quot;</span>      <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Maranhão&quot;</span>                <span class="p">,</span>   <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span>
<a id="__codelineno-31-7" name="__codelineno-31-7"></a>        <span class="n">mato_grosso</span>     <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;mato_grosso&quot;</span>   <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Mato Grosso&quot;</span>             <span class="p">,</span>   <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span>
<a id="__codelineno-31-8" name="__codelineno-31-8"></a>        <span class="n">para</span>            <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;para&quot;</span>          <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Pará&quot;</span>                    <span class="p">,</span>   <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span>                             
<a id="__codelineno-31-9" name="__codelineno-31-9"></a>        <span class="n">rondonia</span>        <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;rondonia&quot;</span>      <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Rondônia&quot;</span>                <span class="p">,</span>   <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span>
<a id="__codelineno-31-10" name="__codelineno-31-10"></a>        <span class="n">roraima</span>         <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;roraima&quot;</span>       <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Roraima&quot;</span>                 <span class="p">,</span>   <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span>
<a id="__codelineno-31-11" name="__codelineno-31-11"></a>        <span class="n">tocantins</span>       <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;tocantins&quot;</span>     <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Tocantins&quot;</span>               <span class="p">,</span>   <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;             &quot;</span><span class="p">}</span>
<a id="__codelineno-31-12" name="__codelineno-31-12"></a>        <span class="n">all_locations</span>   <span class="o">=</span>   <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;all_locations&quot;</span> <span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Amazônia Legal&quot;</span>          <span class="p">,</span>   <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Engloba os estados brasileiros pertencentes à Bacia amazônica&quot;</span><span class="p">}</span> 
<a id="__codelineno-31-13" name="__codelineno-31-13"></a>
<a id="__codelineno-31-14" name="__codelineno-31-14"></a>        <span class="n">location_options</span>    <span class="o">=</span>   <span class="p">[]</span>
<a id="__codelineno-31-15" name="__codelineno-31-15"></a>
<a id="__codelineno-31-16" name="__codelineno-31-16"></a>        <span class="k">if</span>  <span class="nb">len</span><span class="p">(</span><span class="n">user_locations</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">:</span>
<a id="__codelineno-31-17" name="__codelineno-31-17"></a>            <span class="n">location_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_locations</span><span class="p">)</span>
<a id="__codelineno-31-18" name="__codelineno-31-18"></a>
<a id="__codelineno-31-19" name="__codelineno-31-19"></a>        <span class="k">if</span> <span class="s2">&quot;acre&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_locations</span><span class="p">:</span>
<a id="__codelineno-31-20" name="__codelineno-31-20"></a>            <span class="n">location_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acre</span><span class="p">)</span>
<a id="__codelineno-31-21" name="__codelineno-31-21"></a>
<a id="__codelineno-31-22" name="__codelineno-31-22"></a>        <span class="k">if</span> <span class="s2">&quot;amapa&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_locations</span><span class="p">:</span>
<a id="__codelineno-31-23" name="__codelineno-31-23"></a>            <span class="n">location_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amapa</span><span class="p">)</span>
<a id="__codelineno-31-24" name="__codelineno-31-24"></a>
<a id="__codelineno-31-25" name="__codelineno-31-25"></a>        <span class="k">if</span> <span class="s2">&quot;amazonas&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_locations</span><span class="p">:</span>
<a id="__codelineno-31-26" name="__codelineno-31-26"></a>            <span class="n">location_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amazonas</span><span class="p">)</span>
<a id="__codelineno-31-27" name="__codelineno-31-27"></a>
<a id="__codelineno-31-28" name="__codelineno-31-28"></a>        <span class="k">if</span> <span class="s2">&quot;maranhao&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_locations</span><span class="p">:</span>
<a id="__codelineno-31-29" name="__codelineno-31-29"></a>            <span class="n">location_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maranhao</span><span class="p">)</span>
<a id="__codelineno-31-30" name="__codelineno-31-30"></a>
<a id="__codelineno-31-31" name="__codelineno-31-31"></a>        <span class="k">if</span> <span class="s2">&quot;mato_grosso&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_locations</span><span class="p">:</span>
<a id="__codelineno-31-32" name="__codelineno-31-32"></a>            <span class="n">location_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mato_grosso</span><span class="p">)</span>            
<a id="__codelineno-31-33" name="__codelineno-31-33"></a>
<a id="__codelineno-31-34" name="__codelineno-31-34"></a>        <span class="k">if</span> <span class="s2">&quot;para&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_locations</span><span class="p">:</span>
<a id="__codelineno-31-35" name="__codelineno-31-35"></a>            <span class="n">location_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">para</span><span class="p">)</span>
<a id="__codelineno-31-36" name="__codelineno-31-36"></a>
<a id="__codelineno-31-37" name="__codelineno-31-37"></a>        <span class="k">if</span> <span class="s2">&quot;rondonia&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_locations</span><span class="p">:</span>
<a id="__codelineno-31-38" name="__codelineno-31-38"></a>            <span class="n">location_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rondonia</span><span class="p">)</span>
<a id="__codelineno-31-39" name="__codelineno-31-39"></a>
<a id="__codelineno-31-40" name="__codelineno-31-40"></a>        <span class="k">if</span> <span class="s2">&quot;roraima&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_locations</span><span class="p">:</span>
<a id="__codelineno-31-41" name="__codelineno-31-41"></a>            <span class="n">location_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roraima</span><span class="p">)</span>
<a id="__codelineno-31-42" name="__codelineno-31-42"></a>
<a id="__codelineno-31-43" name="__codelineno-31-43"></a>        <span class="k">if</span> <span class="s2">&quot;tocantins&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_locations</span><span class="p">:</span>
<a id="__codelineno-31-44" name="__codelineno-31-44"></a>            <span class="n">location_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tocantins</span><span class="p">)</span>
<a id="__codelineno-31-45" name="__codelineno-31-45"></a>
<a id="__codelineno-31-46" name="__codelineno-31-46"></a>
<a id="__codelineno-31-47" name="__codelineno-31-47"></a>        <span class="n">locations</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-31-48" name="__codelineno-31-48"></a>
<a id="__codelineno-31-49" name="__codelineno-31-49"></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span>
<a id="__codelineno-31-50" name="__codelineno-31-50"></a>                    <span class="s2">&quot;header&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-31-51" name="__codelineno-31-51"></a>                      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-31-52" name="__codelineno-31-52"></a>                      <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Escolha os estados:&quot;</span>
<a id="__codelineno-31-53" name="__codelineno-31-53"></a>                    <span class="p">},</span>
<a id="__codelineno-31-54" name="__codelineno-31-54"></a>                    <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-31-55" name="__codelineno-31-55"></a>                      <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;📝 Selecione uma das opções.&quot;</span>
<a id="__codelineno-31-56" name="__codelineno-31-56"></a>                    <span class="p">},</span>
<a id="__codelineno-31-57" name="__codelineno-31-57"></a>                    <span class="s2">&quot;footer&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-31-58" name="__codelineno-31-58"></a>                      <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;‎ &quot;</span>
<a id="__codelineno-31-59" name="__codelineno-31-59"></a>                    <span class="p">},</span>
<a id="__codelineno-31-60" name="__codelineno-31-60"></a>                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-31-61" name="__codelineno-31-61"></a>                      <span class="s2">&quot;button&quot;</span><span class="p">:</span> <span class="s2">&quot;Clique aqui&quot;</span><span class="p">,</span>
<a id="__codelineno-31-62" name="__codelineno-31-62"></a>                      <span class="s2">&quot;sections&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-31-63" name="__codelineno-31-63"></a>                        <span class="p">{</span>
<a id="__codelineno-31-64" name="__codelineno-31-64"></a>                          <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;personalize o conteúdo&quot;</span><span class="p">,</span>
<a id="__codelineno-31-65" name="__codelineno-31-65"></a>                          <span class="s2">&quot;rows&quot;</span><span class="p">:</span><span class="n">location_options</span>
<a id="__codelineno-31-66" name="__codelineno-31-66"></a>                        <span class="p">}</span>
<a id="__codelineno-31-67" name="__codelineno-31-67"></a>
<a id="__codelineno-31-68" name="__codelineno-31-68"></a>                      <span class="p">]</span>
<a id="__codelineno-31-69" name="__codelineno-31-69"></a>                    <span class="p">}</span>
<a id="__codelineno-31-70" name="__codelineno-31-70"></a>                  <span class="p">}</span>
<a id="__codelineno-31-71" name="__codelineno-31-71"></a>
<a id="__codelineno-31-72" name="__codelineno-31-72"></a>
<a id="__codelineno-31-73" name="__codelineno-31-73"></a>        <span class="k">return</span> <span class="n">locations</span>
</code></pre></div></td></tr></table></div></p>
<h4 id="locations-options">Locations options</h4>
<p>This method show to user the locations options</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-32-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-32-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-32-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-32-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-32-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-32-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-32-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-32-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-32-10">10</a></span>
<span class="normal"><a href="#__codelineno-32-11">11</a></span>
<span class="normal"><a href="#__codelineno-32-12">12</a></span>
<span class="normal"><a href="#__codelineno-32-13">13</a></span>
<span class="normal"><a href="#__codelineno-32-14">14</a></span>
<span class="normal"><a href="#__codelineno-32-15">15</a></span>
<span class="normal"><a href="#__codelineno-32-16">16</a></span>
<span class="normal"><a href="#__codelineno-32-17">17</a></span>
<span class="normal"><a href="#__codelineno-32-18">18</a></span>
<span class="normal"><a href="#__codelineno-32-19">19</a></span>
<span class="normal"><a href="#__codelineno-32-20">20</a></span>
<span class="normal"><a href="#__codelineno-32-21">21</a></span>
<span class="normal"><a href="#__codelineno-32-22">22</a></span>
<span class="normal"><a href="#__codelineno-32-23">23</a></span>
<span class="normal"><a href="#__codelineno-32-24">24</a></span>
<span class="normal"><a href="#__codelineno-32-25">25</a></span>
<span class="normal"><a href="#__codelineno-32-26">26</a></span>
<span class="normal"><a href="#__codelineno-32-27">27</a></span>
<span class="normal"><a href="#__codelineno-32-28">28</a></span>
<span class="normal"><a href="#__codelineno-32-29">29</a></span>
<span class="normal"><a href="#__codelineno-32-30">30</a></span>
<span class="normal"><a href="#__codelineno-32-31">31</a></span>
<span class="normal"><a href="#__codelineno-32-32">32</a></span>
<span class="normal"><a href="#__codelineno-32-33">33</a></span>
<span class="normal"><a href="#__codelineno-32-34">34</a></span>
<span class="normal"><a href="#__codelineno-32-35">35</a></span>
<span class="normal"><a href="#__codelineno-32-36">36</a></span>
<span class="normal"><a href="#__codelineno-32-37">37</a></span>
<span class="normal"><a href="#__codelineno-32-38">38</a></span>
<span class="normal"><a href="#__codelineno-32-39">39</a></span>
<span class="normal"><a href="#__codelineno-32-40">40</a></span>
<span class="normal"><a href="#__codelineno-32-41">41</a></span>
<span class="normal"><a href="#__codelineno-32-42">42</a></span>
<span class="normal"><a href="#__codelineno-32-43">43</a></span>
<span class="normal"><a href="#__codelineno-32-44">44</a></span>
<span class="normal"><a href="#__codelineno-32-45">45</a></span>
<span class="normal"><a href="#__codelineno-32-46">46</a></span>
<span class="normal"><a href="#__codelineno-32-47">47</a></span>
<span class="normal"><a href="#__codelineno-32-48">48</a></span>
<span class="normal"><a href="#__codelineno-32-49">49</a></span>
<span class="normal"><a href="#__codelineno-32-50">50</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a>    <span class="k">def</span> <span class="nf">__choose_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span><span class="n">msg_id</span><span class="p">):</span>
<a id="__codelineno-32-2" name="__codelineno-32-2"></a>        <span class="n">choose_locations</span>    <span class="o">=</span>   <span class="s2">&quot;👍Legal! Agora você poderá escolher de qual estado deseja receber conteúdos sobre a Amazônia 🌳. Selecione o primeiro estado 🇧🇷.&quot;</span>
<a id="__codelineno-32-3" name="__codelineno-32-3"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]:</span>
<a id="__codelineno-32-4" name="__codelineno-32-4"></a>            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;all_content&quot;</span><span class="p">):</span>
<a id="__codelineno-32-5" name="__codelineno-32-5"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;Você já estava cadastrado para receber todo nosso conteúdo 😃&quot;</span><span class="p">)</span>
<a id="__codelineno-32-6" name="__codelineno-32-6"></a>                <span class="k">return</span> <span class="kc">True</span>     
<a id="__codelineno-32-7" name="__codelineno-32-7"></a>
<a id="__codelineno-32-8" name="__codelineno-32-8"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;locations_prefs&quot;</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">9</span><span class="p">:</span>
<a id="__codelineno-32-9" name="__codelineno-32-9"></a>            <span class="n">menu</span>    <span class="o">=</span>   <span class="bp">self</span><span class="o">.</span><span class="n">__create_location_menu</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;locations_prefs&quot;</span><span class="p">))</span>
<a id="__codelineno-32-10" name="__codelineno-32-10"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-32-11" name="__codelineno-32-11"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;Você já se cadastrou em todos os estados 😃&quot;</span><span class="p">)</span>
<a id="__codelineno-32-12" name="__codelineno-32-12"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-32-13" name="__codelineno-32-13"></a>
<a id="__codelineno-32-14" name="__codelineno-32-14"></a>        <span class="k">if</span> <span class="n">msg_id</span> <span class="o">==</span><span class="s2">&quot;MAIN_LOCATIONS&quot;</span><span class="p">:</span>
<a id="__codelineno-32-15" name="__codelineno-32-15"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">choose_locations</span><span class="p">)</span>
<a id="__codelineno-32-16" name="__codelineno-32-16"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;interactive&quot;</span><span class="p">,</span> <span class="n">menu</span><span class="p">)</span> 
<a id="__codelineno-32-17" name="__codelineno-32-17"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-32-18" name="__codelineno-32-18"></a>
<a id="__codelineno-32-19" name="__codelineno-32-19"></a>        <span class="k">if</span>  <span class="n">msg_id</span><span class="o">==</span><span class="s2">&quot;LOCATION_BTN_YES&quot;</span><span class="p">:</span>
<a id="__codelineno-32-20" name="__codelineno-32-20"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;locations_prefs&quot;</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">9</span><span class="p">:</span>
<a id="__codelineno-32-21" name="__codelineno-32-21"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;Vamos escolher outro estado para receber conteúdos sobre a Amazônia 🌳&quot;</span><span class="p">)</span>
<a id="__codelineno-32-22" name="__codelineno-32-22"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;interactive&quot;</span><span class="p">,</span> <span class="n">menu</span><span class="p">)</span> 
<a id="__codelineno-32-23" name="__codelineno-32-23"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-32-24" name="__codelineno-32-24"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;ALL_CONTENT&quot;</span><span class="p">))</span>
<a id="__codelineno-32-25" name="__codelineno-32-25"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-32-26" name="__codelineno-32-26"></a>
<a id="__codelineno-32-27" name="__codelineno-32-27"></a>
<a id="__codelineno-32-28" name="__codelineno-32-28"></a>        <span class="k">if</span> <span class="n">msg_id</span> <span class="o">==</span><span class="s2">&quot;all_locations&quot;</span><span class="p">:</span>
<a id="__codelineno-32-29" name="__codelineno-32-29"></a>            <span class="n">user</span><span class="p">[</span><span class="s2">&quot;locations_prefs&quot;</span><span class="p">]</span> <span class="o">=</span>   <span class="p">[</span><span class="s2">&quot;Acre&quot;</span><span class="p">,</span> <span class="s2">&quot;Amapá&quot;</span><span class="p">,</span> <span class="s2">&quot;Amazonas&quot;</span><span class="p">,</span> <span class="s2">&quot;Maranhão&quot;</span><span class="p">,</span> <span class="s2">&quot;Mato Grosso&quot;</span><span class="p">,</span> <span class="s2">&quot;Pará&quot;</span><span class="p">,</span> <span class="s2">&quot;Rondônia&quot;</span><span class="p">,</span> <span class="s2">&quot;Roraima&quot;</span><span class="p">,</span> <span class="s2">&quot;Tocantins&quot;</span><span class="p">]</span>        
<a id="__codelineno-32-30" name="__codelineno-32-30"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__save_user_prefs</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-32-31" name="__codelineno-32-31"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;ALL_CONTENT&quot;</span><span class="p">))</span>
<a id="__codelineno-32-32" name="__codelineno-32-32"></a>
<a id="__codelineno-32-33" name="__codelineno-32-33"></a>
<a id="__codelineno-32-34" name="__codelineno-32-34"></a>        <span class="k">if</span> <span class="n">msg_id</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;acre&quot;</span><span class="p">,</span><span class="s2">&quot;amapa&quot;</span><span class="p">,</span><span class="s2">&quot;amazonas&quot;</span><span class="p">,</span><span class="s2">&quot;maranhao&quot;</span><span class="p">,</span><span class="s2">&quot;mato_grosso&quot;</span><span class="p">,</span><span class="s2">&quot;para&quot;</span><span class="p">,</span><span class="s2">&quot;rondonia&quot;</span><span class="p">,</span> <span class="s2">&quot;roraima&quot;</span><span class="p">,</span><span class="s2">&quot;tocantins&quot;</span><span class="p">,</span> <span class="s2">&quot;LOCATION_BTN_NO&quot;</span><span class="p">,</span> <span class="s2">&quot;LOCATION_BTN_YES&quot;</span><span class="p">]:</span>
<a id="__codelineno-32-35" name="__codelineno-32-35"></a>            <span class="k">if</span>  <span class="n">msg_id</span> <span class="ow">not</span>  <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LOCATION_BTN_YES&quot;</span><span class="p">,</span><span class="s2">&quot;LOCATION_BTN_NO&quot;</span><span class="p">]:</span>
<a id="__codelineno-32-36" name="__codelineno-32-36"></a>                <span class="n">states_dict</span><span class="o">=</span> <span class="p">{</span><span class="s2">&quot;acre&quot;</span><span class="p">:</span><span class="s2">&quot;Acre&quot;</span><span class="p">,</span> <span class="s2">&quot;amapa&quot;</span><span class="p">:</span><span class="s2">&quot;Amapá&quot;</span><span class="p">,</span> <span class="s2">&quot;amazonas&quot;</span><span class="p">:</span><span class="s2">&quot;Amazonas&quot;</span><span class="p">,</span> <span class="s2">&quot;maranhao&quot;</span><span class="p">:</span><span class="s2">&quot;Maranhão&quot;</span><span class="p">,</span> <span class="s2">&quot;mato_grosso&quot;</span><span class="p">:</span><span class="s2">&quot;Mato Grosso&quot;</span><span class="p">}</span>
<a id="__codelineno-32-37" name="__codelineno-32-37"></a>                <span class="n">states_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;para&quot;</span><span class="p">:</span><span class="s2">&quot;Pará&quot;</span><span class="p">,</span> <span class="s2">&quot;rondonia&quot;</span><span class="p">:</span><span class="s2">&quot;Rondônia&quot;</span><span class="p">,</span> <span class="s2">&quot;roraima&quot;</span><span class="p">:</span><span class="s2">&quot;Roraima&quot;</span><span class="p">,</span> <span class="s2">&quot;tocantins&quot;</span><span class="p">:</span><span class="s2">&quot;Tocantins&quot;</span><span class="p">})</span>
<a id="__codelineno-32-38" name="__codelineno-32-38"></a>                <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;locations_prefs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">states_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">msg_id</span><span class="p">))</span> 
<a id="__codelineno-32-39" name="__codelineno-32-39"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__save_user_prefs</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-32-40" name="__codelineno-32-40"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;locations_prefs&quot;</span><span class="p">))</span><span class="o">==</span><span class="mi">9</span><span class="p">:</span>
<a id="__codelineno-32-41" name="__codelineno-32-41"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;ALL_CONTENT&quot;</span><span class="p">))</span>
<a id="__codelineno-32-42" name="__codelineno-32-42"></a>
<a id="__codelineno-32-43" name="__codelineno-32-43"></a>
<a id="__codelineno-32-44" name="__codelineno-32-44"></a>            <span class="k">if</span>  <span class="n">msg_id</span><span class="o">!=</span> <span class="s2">&quot;LOCATION_BTN_NO&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;locations_prefs&quot;</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">9</span><span class="p">:</span>  
<a id="__codelineno-32-45" name="__codelineno-32-45"></a>                <span class="n">button</span>  <span class="o">=</span>   <span class="bp">self</span><span class="o">.</span><span class="n">create_button</span><span class="p">(</span><span class="s2">&quot;🇧🇷 Quer receber conteúdos de outros estados?&quot;</span><span class="p">,</span> <span class="s2">&quot;Sim&quot;</span><span class="p">,</span> <span class="s2">&quot;LOCATION_BTN_YES&quot;</span><span class="p">,</span> <span class="s2">&quot;Não&quot;</span><span class="p">,</span> <span class="s2">&quot;LOCATION_BTN_NO&quot;</span> <span class="p">)</span>
<a id="__codelineno-32-46" name="__codelineno-32-46"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;interactive&quot;</span><span class="p">,</span> <span class="n">button</span><span class="p">)</span>
<a id="__codelineno-32-47" name="__codelineno-32-47"></a>                <span class="k">return</span> <span class="kc">True</span> 
<a id="__codelineno-32-48" name="__codelineno-32-48"></a>            <span class="k">if</span>  <span class="n">msg_id</span><span class="o">==</span> <span class="s2">&quot;LOCATION_BTN_NO&quot;</span><span class="p">:</span>     
<a id="__codelineno-32-49" name="__codelineno-32-49"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;ALL_CONTENT&quot;</span><span class="p">))</span>            
<a id="__codelineno-32-50" name="__codelineno-32-50"></a>                <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
<h4 id="manage-the-users-choices">Manage the user's choices</h4>
<p>This method manage of the users messages.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span>
<span class="normal"><a href="#__codelineno-33-12">12</a></span>
<span class="normal"><a href="#__codelineno-33-13">13</a></span>
<span class="normal"><a href="#__codelineno-33-14">14</a></span>
<span class="normal"><a href="#__codelineno-33-15">15</a></span>
<span class="normal"><a href="#__codelineno-33-16">16</a></span>
<span class="normal"><a href="#__codelineno-33-17">17</a></span>
<span class="normal"><a href="#__codelineno-33-18">18</a></span>
<span class="normal"><a href="#__codelineno-33-19">19</a></span>
<span class="normal"><a href="#__codelineno-33-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a>    <span class="k">def</span> <span class="nf">__choose_prefs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="n">response</span><span class="p">):</span>
<a id="__codelineno-33-2" name="__codelineno-33-2"></a>        <span class="k">if</span>  <span class="n">response</span><span class="p">[</span><span class="s2">&quot;interactive&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">==</span> <span class="s2">&quot;list_reply&quot;</span><span class="p">:</span>
<a id="__codelineno-33-3" name="__codelineno-33-3"></a>            <span class="n">list_reply</span>  <span class="o">=</span>   <span class="n">response</span><span class="p">[</span><span class="s2">&quot;interactive&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;list_reply&quot;</span><span class="p">)</span>   
<a id="__codelineno-33-4" name="__codelineno-33-4"></a>            <span class="n">msg_id</span>      <span class="o">=</span>   <span class="n">list_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
<a id="__codelineno-33-5" name="__codelineno-33-5"></a>
<a id="__codelineno-33-6" name="__codelineno-33-6"></a>        <span class="k">if</span>  <span class="n">response</span><span class="p">[</span><span class="s2">&quot;interactive&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">==</span> <span class="s2">&quot;button_reply&quot;</span><span class="p">:</span>
<a id="__codelineno-33-7" name="__codelineno-33-7"></a>            <span class="n">btn_reply</span>   <span class="o">=</span>   <span class="n">response</span><span class="p">[</span><span class="s2">&quot;interactive&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;button_reply&quot;</span><span class="p">)</span> 
<a id="__codelineno-33-8" name="__codelineno-33-8"></a>            <span class="n">msg_id</span>      <span class="o">=</span>   <span class="n">btn_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>     
<a id="__codelineno-33-9" name="__codelineno-33-9"></a>
<a id="__codelineno-33-10" name="__codelineno-33-10"></a>        <span class="k">if</span>  <span class="n">msg_id</span>  <span class="o">==</span><span class="s2">&quot;MAIN_ALL_CONTENT&quot;</span><span class="p">:</span>
<a id="__codelineno-33-11" name="__codelineno-33-11"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__choose_all</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
<a id="__codelineno-33-12" name="__codelineno-33-12"></a>
<a id="__codelineno-33-13" name="__codelineno-33-13"></a>        <span class="k">if</span>  <span class="n">msg_id</span>  <span class="o">==</span><span class="s2">&quot;MAIN_ABOUT&quot;</span><span class="p">:</span>
<a id="__codelineno-33-14" name="__codelineno-33-14"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="s2">&quot;about&quot;</span><span class="p">))</span>
<a id="__codelineno-33-15" name="__codelineno-33-15"></a>
<a id="__codelineno-33-16" name="__codelineno-33-16"></a>        <span class="k">if</span>  <span class="n">msg_id</span>  <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;MAIN_TOPCIS&quot;</span><span class="p">,</span> <span class="s2">&quot;danos_ambientais&quot;</span><span class="p">,</span><span class="s2">&quot;areas_protegidas&quot;</span><span class="p">,</span><span class="s2">&quot;povos&quot;</span><span class="p">,</span><span class="s2">&quot;mudanca_climatica&quot;</span><span class="p">,</span><span class="s2">&quot;conservacao&quot;</span><span class="p">,</span><span class="s2">&quot;politica_economia&quot;</span><span class="p">,</span><span class="s2">&quot;all_topics&quot;</span><span class="p">,</span><span class="s2">&quot;TOPIC_BTN_NO&quot;</span><span class="p">,</span> <span class="s2">&quot;TOPIC_BTN_YES&quot;</span><span class="p">]:</span>
<a id="__codelineno-33-17" name="__codelineno-33-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__choose_topics</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">)</span>        
<a id="__codelineno-33-18" name="__codelineno-33-18"></a>
<a id="__codelineno-33-19" name="__codelineno-33-19"></a>        <span class="k">if</span>  <span class="n">msg_id</span>  <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;MAIN_LOCATIONS&quot;</span><span class="p">,</span> <span class="s2">&quot;acre&quot;</span><span class="p">,</span><span class="s2">&quot;amapa&quot;</span><span class="p">,</span><span class="s2">&quot;amazonas&quot;</span><span class="p">,</span><span class="s2">&quot;maranhao&quot;</span><span class="p">,</span><span class="s2">&quot;mato_grosso&quot;</span><span class="p">,</span><span class="s2">&quot;para&quot;</span><span class="p">,</span><span class="s2">&quot;rondonia&quot;</span><span class="p">,</span> <span class="s2">&quot;roraima&quot;</span><span class="p">,</span><span class="s2">&quot;tocantins&quot;</span><span class="p">,</span> <span class="s2">&quot;all_locations&quot;</span><span class="p">,</span><span class="s2">&quot;LOCATION_BTN_NO&quot;</span><span class="p">,</span> <span class="s2">&quot;LOCATION_BTN_YES&quot;</span><span class="p">]:</span>
<a id="__codelineno-33-20" name="__codelineno-33-20"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__choose_locations</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="process-subscriptions">Process subscriptions</h4>
<p>This method is responsible for processing user messages. It retrieves the user ID and name from the response and queries the user preferences from the database. If the user preferences exist, it retrieves the existing user data; otherwise, it creates a new user with the provided ID and name. The method then checks the subscription status of the user. If the subscription is set to False, it performs an action to handle unsubscribed users. If the message type is "interactive" and the interactive type is either "list_reply" or "button_reply," it proceeds to choose the user preferences based on the response. In case of any exceptions, an error message is printed.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-34-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-34-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-34-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-34-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-34-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-34-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-34-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-34-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-34-10">10</a></span>
<span class="normal"><a href="#__codelineno-34-11">11</a></span>
<span class="normal"><a href="#__codelineno-34-12">12</a></span>
<span class="normal"><a href="#__codelineno-34-13">13</a></span>
<span class="normal"><a href="#__codelineno-34-14">14</a></span>
<span class="normal"><a href="#__codelineno-34-15">15</a></span>
<span class="normal"><a href="#__codelineno-34-16">16</a></span>
<span class="normal"><a href="#__codelineno-34-17">17</a></span>
<span class="normal"><a href="#__codelineno-34-18">18</a></span>
<span class="normal"><a href="#__codelineno-34-19">19</a></span>
<span class="normal"><a href="#__codelineno-34-20">20</a></span>
<span class="normal"><a href="#__codelineno-34-21">21</a></span>
<span class="normal"><a href="#__codelineno-34-22">22</a></span>
<span class="normal"><a href="#__codelineno-34-23">23</a></span>
<span class="normal"><a href="#__codelineno-34-24">24</a></span>
<span class="normal"><a href="#__codelineno-34-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a>    <span class="k">def</span> <span class="nf">__process_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">response</span><span class="p">):</span>
<a id="__codelineno-34-2" name="__codelineno-34-2"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-34-3" name="__codelineno-34-3"></a>            <span class="n">user_id</span>     <span class="o">=</span>   <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span>
<a id="__codelineno-34-4" name="__codelineno-34-4"></a>            <span class="n">user_name</span>   <span class="o">=</span>   <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
<a id="__codelineno-34-5" name="__codelineno-34-5"></a>            <span class="n">user_query</span>  <span class="o">=</span>   <span class="bp">self</span><span class="o">.</span><span class="n">__get_user_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<a id="__codelineno-34-6" name="__codelineno-34-6"></a>            <span class="n">user</span>        <span class="o">=</span>   <span class="p">{}</span>
<a id="__codelineno-34-7" name="__codelineno-34-7"></a>            <span class="k">if</span> <span class="n">user_query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
<a id="__codelineno-34-8" name="__codelineno-34-8"></a>                <span class="n">user</span>            <span class="o">=</span>   <span class="n">user_query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
<a id="__codelineno-34-9" name="__codelineno-34-9"></a>                <span class="n">user</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span>     <span class="o">=</span>   <span class="kc">False</span>
<a id="__codelineno-34-10" name="__codelineno-34-10"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-34-11" name="__codelineno-34-11"></a>                <span class="n">user</span>            <span class="o">=</span>   <span class="bp">self</span><span class="o">.</span><span class="n">__create_user</span><span class="p">(</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[],</span>  <span class="p">[])</span>           
<a id="__codelineno-34-12" name="__codelineno-34-12"></a>                <span class="n">user</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span>     <span class="o">=</span>   <span class="kc">True</span>
<a id="__codelineno-34-13" name="__codelineno-34-13"></a>
<a id="__codelineno-34-14" name="__codelineno-34-14"></a>            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;subscription&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-34-15" name="__codelineno-34-15"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">unsubscribed</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>     
<a id="__codelineno-34-16" name="__codelineno-34-16"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-34-17" name="__codelineno-34-17"></a>
<a id="__codelineno-34-18" name="__codelineno-34-18"></a>            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message_type&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;interactive&quot;</span><span class="p">:</span>
<a id="__codelineno-34-19" name="__codelineno-34-19"></a>                <span class="k">if</span>  <span class="n">response</span><span class="p">[</span><span class="s2">&quot;interactive&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;list_reply&quot;</span> <span class="ow">or</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;interactive&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;button_reply&quot;</span><span class="p">:</span>
<a id="__codelineno-34-20" name="__codelineno-34-20"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">__choose_prefs</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-34-21" name="__codelineno-34-21"></a>
<a id="__codelineno-34-22" name="__codelineno-34-22"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-34-23" name="__codelineno-34-23"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;/////////////////////////////////////////////////////////////////////////////////////&quot;</span><span class="p">)</span>
<a id="__codelineno-34-24" name="__codelineno-34-24"></a>            <span class="nb">print</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-34-25" name="__codelineno-34-25"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;/////////////////////////////////////////////////////////////////////////////////////&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="process-statuses">Process statuses</h4>
<p>This method is responsible for processing the statuses of user messages, specifically whether they have been sent, delivered, or read, and saving the status information in the database. It iterates through the provided data and retrieves the message ID (wamid) for each status. It then queries the database to find the corresponding message based on the wamid. If the message is found, it retrieves the status information from the data and the recipient ID. The method updates the message document in the database based on the status. For example, if the status is "sent," it sets the 'sent' field to True and records the send date. Similarly, for "delivered," "read," and "failed" statuses, corresponding fields are updated with the respective values and dates. If any exceptions occur, an error message is printed.
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-35-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-35-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-35-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-35-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-35-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-35-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-35-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-35-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-35-10">10</a></span>
<span class="normal"><a href="#__codelineno-35-11">11</a></span>
<span class="normal"><a href="#__codelineno-35-12">12</a></span>
<span class="normal"><a href="#__codelineno-35-13">13</a></span>
<span class="normal"><a href="#__codelineno-35-14">14</a></span>
<span class="normal"><a href="#__codelineno-35-15">15</a></span>
<span class="normal"><a href="#__codelineno-35-16">16</a></span>
<span class="normal"><a href="#__codelineno-35-17">17</a></span>
<span class="normal"><a href="#__codelineno-35-18">18</a></span>
<span class="normal"><a href="#__codelineno-35-19">19</a></span>
<span class="normal"><a href="#__codelineno-35-20">20</a></span>
<span class="normal"><a href="#__codelineno-35-21">21</a></span>
<span class="normal"><a href="#__codelineno-35-22">22</a></span>
<span class="normal"><a href="#__codelineno-35-23">23</a></span>
<span class="normal"><a href="#__codelineno-35-24">24</a></span>
<span class="normal"><a href="#__codelineno-35-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a>    <span class="k">def</span> <span class="nf">__process_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">response</span><span class="p">):</span>
<a id="__codelineno-35-2" name="__codelineno-35-2"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-35-3" name="__codelineno-35-3"></a>            <span class="n">user_id</span>     <span class="o">=</span>   <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span>
<a id="__codelineno-35-4" name="__codelineno-35-4"></a>            <span class="n">user_name</span>   <span class="o">=</span>   <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
<a id="__codelineno-35-5" name="__codelineno-35-5"></a>            <span class="n">user_query</span>  <span class="o">=</span>   <span class="bp">self</span><span class="o">.</span><span class="n">__get_user_prefs</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<a id="__codelineno-35-6" name="__codelineno-35-6"></a>            <span class="n">user</span>        <span class="o">=</span>   <span class="p">{}</span>
<a id="__codelineno-35-7" name="__codelineno-35-7"></a>            <span class="k">if</span> <span class="n">user_query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
<a id="__codelineno-35-8" name="__codelineno-35-8"></a>                <span class="n">user</span>            <span class="o">=</span>   <span class="n">user_query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
<a id="__codelineno-35-9" name="__codelineno-35-9"></a>                <span class="n">user</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span>     <span class="o">=</span>   <span class="kc">False</span>
<a id="__codelineno-35-10" name="__codelineno-35-10"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-35-11" name="__codelineno-35-11"></a>                <span class="n">user</span>            <span class="o">=</span>   <span class="bp">self</span><span class="o">.</span><span class="n">__create_user</span><span class="p">(</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[],</span>  <span class="p">[])</span>           
<a id="__codelineno-35-12" name="__codelineno-35-12"></a>                <span class="n">user</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span>     <span class="o">=</span>   <span class="kc">True</span>
<a id="__codelineno-35-13" name="__codelineno-35-13"></a>
<a id="__codelineno-35-14" name="__codelineno-35-14"></a>            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;subscription&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-35-15" name="__codelineno-35-15"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">unsubscribed</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>     
<a id="__codelineno-35-16" name="__codelineno-35-16"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-35-17" name="__codelineno-35-17"></a>
<a id="__codelineno-35-18" name="__codelineno-35-18"></a>            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message_type&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;interactive&quot;</span><span class="p">:</span>
<a id="__codelineno-35-19" name="__codelineno-35-19"></a>                <span class="k">if</span>  <span class="n">response</span><span class="p">[</span><span class="s2">&quot;interactive&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;list_reply&quot;</span> <span class="ow">or</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;interactive&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;button_reply&quot;</span><span class="p">:</span>
<a id="__codelineno-35-20" name="__codelineno-35-20"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">__choose_prefs</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-35-21" name="__codelineno-35-21"></a>
<a id="__codelineno-35-22" name="__codelineno-35-22"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-35-23" name="__codelineno-35-23"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;/////////////////////////////////////////////////////////////////////////////////////&quot;</span><span class="p">)</span>
<a id="__codelineno-35-24" name="__codelineno-35-24"></a>            <span class="nb">print</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-35-25" name="__codelineno-35-25"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;/////////////////////////////////////////////////////////////////////////////////////&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div></p>
<h4 id="process-webhook-notification">Process webhook notification</h4>
<p>This method is responsible for processing a webhook notification. It receives data as input and performs various operations based on the contents of the data. It iterates through the data entries and their changes. If the value contains "statuses," it calls the process_statuses method. Otherwise, it extracts information such as the name, user ID, message type, and subscription status from the data. If the message type is "text," it checks if the client's message is "cancelar" and updates the subscription status accordingly. For interactive messages, it extracts the interactive content. After processing the data, it calls other methods based on the content and message type, such as process_diff_contents and main_menu.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-36-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-36-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-36-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-36-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-36-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-36-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-36-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-36-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-36-10">10</a></span>
<span class="normal"><a href="#__codelineno-36-11">11</a></span>
<span class="normal"><a href="#__codelineno-36-12">12</a></span>
<span class="normal"><a href="#__codelineno-36-13">13</a></span>
<span class="normal"><a href="#__codelineno-36-14">14</a></span>
<span class="normal"><a href="#__codelineno-36-15">15</a></span>
<span class="normal"><a href="#__codelineno-36-16">16</a></span>
<span class="normal"><a href="#__codelineno-36-17">17</a></span>
<span class="normal"><a href="#__codelineno-36-18">18</a></span>
<span class="normal"><a href="#__codelineno-36-19">19</a></span>
<span class="normal"><a href="#__codelineno-36-20">20</a></span>
<span class="normal"><a href="#__codelineno-36-21">21</a></span>
<span class="normal"><a href="#__codelineno-36-22">22</a></span>
<span class="normal"><a href="#__codelineno-36-23">23</a></span>
<span class="normal"><a href="#__codelineno-36-24">24</a></span>
<span class="normal"><a href="#__codelineno-36-25">25</a></span>
<span class="normal"><a href="#__codelineno-36-26">26</a></span>
<span class="normal"><a href="#__codelineno-36-27">27</a></span>
<span class="normal"><a href="#__codelineno-36-28">28</a></span>
<span class="normal"><a href="#__codelineno-36-29">29</a></span>
<span class="normal"><a href="#__codelineno-36-30">30</a></span>
<span class="normal"><a href="#__codelineno-36-31">31</a></span>
<span class="normal"><a href="#__codelineno-36-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a>    <span class="k">def</span> <span class="nf">process_webhook_notification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>   
<a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;_summary_: Process webhook notification</span>
<a id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="sd">        For the moment, this will return the type of notification</span>
<a id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-36-5" name="__codelineno-36-5"></a>        <span class="n">response</span><span class="o">=</span><span class="p">{}</span>
<a id="__codelineno-36-6" name="__codelineno-36-6"></a>        <span class="n">valid_responses</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cancelar&#39;</span><span class="p">]</span>
<a id="__codelineno-36-7" name="__codelineno-36-7"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-36-8" name="__codelineno-36-8"></a>            <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-36-9" name="__codelineno-36-9"></a>            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;entry&quot;</span><span class="p">]:</span>
<a id="__codelineno-36-10" name="__codelineno-36-10"></a>
<a id="__codelineno-36-11" name="__codelineno-36-11"></a>                <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;changes&quot;</span><span class="p">]:</span>
<a id="__codelineno-36-12" name="__codelineno-36-12"></a>
<a id="__codelineno-36-13" name="__codelineno-36-13"></a>                    <span class="n">value</span>                       <span class="o">=</span>   <span class="n">change</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
<a id="__codelineno-36-14" name="__codelineno-36-14"></a>                    <span class="k">if</span> <span class="s2">&quot;statuses&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-36-15" name="__codelineno-36-15"></a>                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_statuses</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-36-16" name="__codelineno-36-16"></a>                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>            <span class="o">=</span>   <span class="n">value</span><span class="p">[</span><span class="s2">&quot;contacts&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;profile&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<a id="__codelineno-36-17" name="__codelineno-36-17"></a>                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span>         <span class="o">=</span>   <span class="n">value</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;from&quot;</span><span class="p">]</span>            
<a id="__codelineno-36-18" name="__codelineno-36-18"></a>                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message_type&quot;</span><span class="p">]</span>    <span class="o">=</span>   <span class="n">value</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
<a id="__codelineno-36-19" name="__codelineno-36-19"></a>                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;subscription&quot;</span><span class="p">]</span>    <span class="o">=</span>   <span class="kc">True</span>
<a id="__codelineno-36-20" name="__codelineno-36-20"></a>
<a id="__codelineno-36-21" name="__codelineno-36-21"></a>                    <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message_type&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;text&quot;</span><span class="p">:</span>
<a id="__codelineno-36-22" name="__codelineno-36-22"></a>                        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;client_message&quot;</span><span class="p">]</span>  <span class="o">=</span>   <span class="n">value</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="s2">&quot;body&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>    
<a id="__codelineno-36-23" name="__codelineno-36-23"></a>                        <span class="k">if</span>  <span class="n">response</span><span class="p">[</span><span class="s2">&quot;client_message&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;cancelar&quot;</span><span class="p">:</span>
<a id="__codelineno-36-24" name="__codelineno-36-24"></a>                            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;subscription&quot;</span><span class="p">]</span>    <span class="o">=</span>   <span class="kc">False</span>
<a id="__codelineno-36-25" name="__codelineno-36-25"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">__process_subscription</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-36-26" name="__codelineno-36-26"></a>
<a id="__codelineno-36-27" name="__codelineno-36-27"></a>                    <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message_type&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;interactive&quot;</span><span class="p">:</span>
<a id="__codelineno-36-28" name="__codelineno-36-28"></a>                        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;interactive&quot;</span><span class="p">]</span> <span class="o">=</span>   <span class="n">value</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;interactive&quot;</span><span class="p">]</span>
<a id="__codelineno-36-29" name="__codelineno-36-29"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">__process_subscription</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-36-30" name="__codelineno-36-30"></a>
<a id="__codelineno-36-31" name="__codelineno-36-31"></a>            <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">process_diff_contents</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;text&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;client_message&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">valid_responses</span><span class="p">):</span>
<a id="__codelineno-36-32" name="__codelineno-36-32"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">main_menu</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>







  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2023 <a href="https://github.com/wilsonceron"  target="_blank" rel="noopener">Wilson Ceron</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/wilsonceron" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/InfoAmazoniaBR" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/company/infoamazonia/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>